-- Title: Library for communicating with SD memory cards
-- Author: Matthew Schinkel - borntechi.com, copyright (c) 2009..2022, all rights reserved.
-- Adapted-by: Rob Jansen + Matthew Schinkel
-- Compiler: 2.5r9
--
-- This file is part of jallib (https://github.com/jallib/jallib)
-- Released under the ZLIB license (http://www.opensource.org/licenses/zlib-license.html)
--
-- Description: this library provides functions for SD memory cards.
--
-- Notes: SD card SPI mode is 1,1
--
--        This version works with standard capacity sd cards up to 4gb and
--        high capacity up to 32 gb. Extended Capacity up to 2TB
--        may be supported later on.
-- 
--        CRC error checking has been implemented but performance is greatly impacted if used.
--
-- Sources:
-- SanDisk Secure Digital Card - http://www.cs.ucr.edu/~amitra/sdcard/ProdManualSDCardv1.9.pdf
-- How to use MMC/SDC - http://forums.parallax.com/forums/attach.aspx?a=32012
-- http://www.rjhcoding.com/avrc-sd-interface-3.php
--

const word SD_BYTE_PER_SECTOR = 512

include print
include spi_master_hw

-- Define sector buffer for SD card operations
-- Use Large Array to set up the sector buffer (512 bytes)
const dword LARGE_ARRAY_6_SIZE = 512         -- choose number of array variables
const dword LARGE_ARRAY_6_VARIABLE_SIZE = 1 -- choose bytes size of variables
include large_array_6                    -- include the array library
alias sd_sector_buffer is large_array_6

-- Conditional CRC support for backwards compatibility
if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
   -- Define CRC-specific aliases
   alias crc_sector_buffer is large_array_6
   alias crc_large_array_bytes is large_array_6  -- alias for CRC libraries
   
   -- Include CRC libraries for direct CRC calculations
   include crc7_sd_card
   include crc16_ccitt_bitwise
   
   --------------------------------------------------------------------------------
   -- Initialize CRC system (for SD card compatibility)
   --------------------------------------------------------------------------------
   procedure crc_init() is
      -- CRC libraries handle their own initialization
      -- This function exists for SD card library compatibility
   end procedure
   
   --------------------------------------------------------------------------------
   -- Clear CRC error (for SD card compatibility)
   --------------------------------------------------------------------------------
   procedure crc_clear_error() is
      -- CRC libraries handle their own error clearing
      -- This function exists for SD card library compatibility
   end procedure
end if

-- defaulting to MSSP1 if none of following aliases are previously defined
if !defined(spi_master_set_mode) then
   alias spi_master_set_mode is spi_master_hw_set_mode
end if
if !defined(spi_master_set_speed) then
   alias spi_master_set_speed is spi_master_hw_set_speed
end if

-- counters
var word sd_byte_count = 0
var word sd_sector_count = 0
var dword sd_sector_select

-- Basic Commands
const byte SD_GO_IDLE_STATE = 0
const byte SD_SEND_OP_COND = 1
const byte SD_SEND_IF_COND = 8  -- for SDHC only
const byte SD_SEND_CSD = 9      -- sd sends "Card Specific Data" standard or high capacity
const byte SD_SEND_CID = 10
const byte SD_STOP_TRANSMISSION = 12
const byte SD_SEND_STATUS = 13

-- Read Commands
const byte SD_SET_BLOCKLEN = 16
const byte SD_READ_SINGLE_BLOCK = 17
const byte SD_READ_MULTIPLE_BLOCK = 18

-- Write Commands
const byte SD_WRITE_BLOCK = 24
const byte SD_WRITE_MULTIPLE_BLOCK = 25
const byte SD_PROGRAM_CSD = 27

-- Write Protection Commands
const byte SD_SET_WRITE_PROT = 28
const byte SD_CLR_WRITE_PROT = 29
const byte SD_SEND_WRITE_PROT = 30

-- Erase Commands
const byte SD_ERASE_WR_BLK_START = 32
const byte SD_ERASE_WR_BLK_END = 33
const byte SD_ERASE = 38

-- Application Specific Commands
const byte SD_APP_CMD = 55 -- indicate that the next command is a application specific command
const byte SD_GEN_CMD = 56

-- Other Commands
const byte SD_READ_OCR = 58
const byte SD_CRC_ON_OFF = 59 -- default is off

-- application specific command, must write command 55 first
const byte SD_SD_STATUS = 13
const byte SD_SEND_NUM_WR_BLOCKS = 22
const byte SD_SET_WR_BLK_ERASE_COUNT = 23
const byte SD_SD_APP_OP_COND = 41
const byte SD_SET_CLR_CARD_DETECT = 42
const byte SD_SEND_SCR = 51

-- R1 RESPONSE BITS
const byte SD_IN_IDLE_STATE = 0
const byte SD_ERASE_RESET = 1
const byte SD_ILLEGAL_COMMAND = 2
const byte SD_COM_CRC_ERROR = 3
const byte SD_ERASE_SEQUENCE_ERROR = 4
const byte SD_ADDRESS_ERROR = 5
const byte SD_PARAMETER_ERROR = 6

-- constants for fat32 library
const PATA_HARD_DISK = 0
const SD_CARD = 1
const DATA_MEDIA = SD_CARD

-- misc variables
var bit sd_card_type = 0
var bit sd_has_init = 0
const bit SD_HIGH_CAPACITY = 0
const bit SD_STANDARD_CAPACITY = 1

-- error codes
-- if any are added, they should be added to sd_print_error()
var bit sd_has_error = 0
var word sd_error_details = 0
--
const byte SD_DEVICE_NOT_FOUND        = 0
const byte SD_TYPE_NOT_SUPPORTED      = 1
const byte SD_INIT_FAILURE            = 2
const byte SD_TIMED_OUT               = 3
const byte SD_COMMAND_TIME_OUT        = 4
const byte SD_COMMAND_NOT_SUPPORTED   = 5
const byte SD_READ_ERROR              = 6
const byte SD_WRITE_ERROR             = 7
const byte SD_CRC_ERROR               = 8
const byte SD_COMMAND_CRC_ERROR       = 9
const byte SD_DATA_CRC_ERROR          = 10

-- Read/write constants
const byte SD_READ = 0
const byte SD_WRITE = 1

-- carrier used to access SD-Card (pseudo-var dealing with SPI)
if !defined(spi_master) then
   alias spi_master is spi_master_hw
end if

-- set storage device
if !defined(STORAGE_DEVICE) then
   const STORAGE_DEVICE = SD_CARD
end if

-- give extra delay after writing.
-- may help to get old standard capacity cards working.
if !defined(SD_DELAY_AFTER_WRITE) then
   const SD_DELAY_AFTER_WRITE = FALSE
end if

-- Extra read & Write speed, takes up program memory, saves ram
if !defined(SD_READ_EXTRA_SPEED) then
   const SD_READ_EXTRA_SPEED = TRUE  -- Enable for better performance
end if
if !defined(SD_WRITE_EXTRA_SPEED) then
   const SD_WRITE_EXTRA_SPEED = TRUE  -- Enable for better performance
end if
if defined(SD_EXTRA_SPEED) then
   _warn "Please remove removed from your sample code."
end if

-- number of sectors variable
var dword sd_number_of_sectors -- number of sectors * 512 = sd card size
procedure sd_get_number_of_sectors() -- procedure prototype

-- prototype the init procedure.
procedure sd_init()




--------------------------------------------------------------------------------
-- Enable the sd card
--------------------------------------------------------------------------------
procedure sd_enable() is
   pragma inline
   spi_master = 0xFF
   sd_chip_select = low
   spi_master = 0xFF
end procedure

--------------------------------------------------------------------------------
-- Disable the sd card
--------------------------------------------------------------------------------
procedure sd_disable() is
   pragma inline
   sd_chip_select = high
   spi_master = 0xFF
end procedure

--------------------------------------------------------------------------------
-- Disable then enable the sd card
--------------------------------------------------------------------------------
procedure sd_toggle() is
   pragma inline
   sd_chip_select = high
   spi_master = 0xFF
   sd_chip_select = low
end procedure

--------------------------------------------------------------------------------
-- set sd_card error
--------------------------------------------------------------------------------
procedure sd_error'put(word in error) is
   var word error_bit = word(1) << error
   sd_error_details = sd_error_details | error_bit
   sd_has_error = 1
end procedure

--------------------------------------------------------------------------------
-- read sd card error (resets error status)
--------------------------------------------------------------------------------
function sd_error'get() return word is
   var word return_val = sd_error_details
   sd_error_details = 0
   return return_val
end function

--------------------------------------------------------------------------------
-- Report sd card error (does NOT reset error status)
--------------------------------------------------------------------------------
procedure sd_print_error(volatile byte out device) is
   if sd_error_details == 0 then
      print_string(device,"NO ERROR")
      print_crlf(device)
   else
      ;print_string(device,"ERROR: ")
      ;print_dword_bin(device,sd_error_details)
      ;print_crlf(device)

      if (sd_error_details & (word(1) << SD_DEVICE_NOT_FOUND )) > 0 then
         print_string(device,"SD_DEVICE_NOT_FOUND ")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_TYPE_NOT_SUPPORTED )) > 0 then
         print_string(device,"SD_TYPE_NOT_SUPPORTED ")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_INIT_FAILURE )) > 0 then
         print_string(device,"SD_INIT_FAILURE ")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_TIMED_OUT)) > 0 then
         print_string(device,"SD_TIMED_OUT")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_COMMAND_TIME_OUT)) > 0 then
         print_string(device,"SD_COMMAND_TIME_OUT")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_COMMAND_NOT_SUPPORTED)) > 0 then
         print_string(device,"SD_COMMAND_NOT_SUPPORTED")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_READ_ERROR)) > 0 then
         print_string(device,"SD_READ_ERROR")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_WRITE_ERROR)) > 0 then
         print_string(device,"SD_WRITE_ERROR")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_CRC_ERROR)) > 0 then
         print_string(device,"SD_CRC_ERROR")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_COMMAND_CRC_ERROR)) > 0 then
         print_string(device,"SD_COMMAND_CRC_ERROR")
         print_crlf(device)
      end if

      if (sd_error_details & (word(1) << SD_DATA_CRC_ERROR)) > 0 then
         print_string(device,"SD_DATA_CRC_ERROR")
         print_crlf(device)
      end if
   end if
end procedure

--------------------------------------------------------------------------------
-- Print R1 Response
--------------------------------------------------------------------------------
procedure sd_print_response(volatile byte out device,byte in response) is
   -- R1 RESPONSE BITS
   var bit IN_IDLE_STATE        at response : SD_IN_IDLE_STATE
   var bit ERASE_RESET          at response : SD_ERASE_RESET
   var bit ILLEGAL_COMMAND      at response : SD_ILLEGAL_COMMAND
   var bit COM_CRC_ERROR        at response : SD_COM_CRC_ERROR
   var bit ERASE_SEQUENCE_ERROR at response : SD_ERASE_SEQUENCE_ERROR
   var bit ADDRESS_ERROR        at response : SD_ADDRESS_ERROR
   var bit PARAMETER_ERROR      at response : SD_PARAMETER_ERROR

   if response == 0xFF then
      const byte str8[] = "Not a Repsonse(0xFF)"
      print_string(device, str8)
      print_crlf(device)
      return
   end if

   if response == 0xFE then
      const byte str9[] = "Not a Repsonse(0xFE)"
      print_string(device, str9)
      print_crlf(device)
   end if

   if response == 0 then
      const byte str0[] = "CARD_READY"
      print_string(device, str0)
      print_crlf(device)
   end if

   if IN_IDLE_STATE == TRUE then
      const byte str1[] = "IN_IDLE_STATE"
      print_string(device, str1)
      print_crlf(device)
   end if

   if ERASE_RESET == TRUE then
      const byte str2[] = "ERASE_RESET"
      print_string(device, str2)
      print_crlf(device)
   end if

   if ILLEGAL_COMMAND == TRUE then
      const byte str3[] = "ILLEGAL_COMMAND"
      print_string(device, str3)
      print_crlf(device)
   end if

   if COM_CRC_ERROR == TRUE then
      const byte str4[] = "COM_CRC_ERROR"
      print_string(device, str4)
      print_crlf(device)
   end if

   if ERASE_SEQUENCE_ERROR == TRUE then
      const byte str5[] = "ERASE_SEQUENCE_ERROR"
      print_string(device, str5)
      print_crlf(device)
   end if

   if ADDRESS_ERROR == TRUE then
      const byte str6[] = "ADDRESS_ERROR"
      print_string(device, str6)
      print_crlf(device)
   end if

   if PARAMETER_ERROR == TRUE then
      const byte str7[] = "PARAMETER_ERROR"
      print_string(device, str7)
      print_crlf(device)
   end if
end procedure

--------------------------------------------------------------------------------
-- send a command to the sd card (commands with 1 response only)
--------------------------------------------------------------------------------
procedure send_command(byte in command,dword in data, byte out response) is
   var byte parameters[4] at data
   var byte x
   
   sd_toggle()

   if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
      -- Enhanced CRC functionality
      var byte crc7_value
      
      -- Calculate proper CRC7 for the command
      -- For CMD0 and CMD8, use special hardcoded values as per SD specification
      if command == SD_GO_IDLE_STATE then
         -- CMD0: 0x40 0x00 0x00 0x00 0x00 -> CRC7 = 0x95
         var byte cmd0_data[5] = {0x40, 0x00, 0x00, 0x00, 0x00}
         crc7_value = crc7_calculate_array_bytes(cmd0_data, 5)
      elsif command == SD_SEND_IF_COND then
         -- CMD8: 0x48 0x00 0x00 0x01 0xAA -> CRC7 = 0x87
         var byte cmd8_data[5] = {0x48, 0x00, 0x00, 0x01, 0xAA}
         crc7_value = crc7_calculate_array_bytes(cmd8_data, 5)
      else
         -- For other commands, calculate CRC7
         var byte command_frame[5]
         command_frame[0] = 0x40 | (command & 0x3F)  -- Start bit + command
         command_frame[1] = byte((data >> 24) & 0xFF)  -- Argument byte 3
         command_frame[2] = byte((data >> 16) & 0xFF)  -- Argument byte 2
         command_frame[3] = byte((data >> 8) & 0xFF)   -- Argument byte 1
         command_frame[4] = byte(data & 0xFF)          -- Argument byte 0
         crc7_value = crc7_calculate_array_bytes(command_frame, 5)
         
         -- Check for CRC calculation errors
         if _crc_error_occurred_crc == TRUE then
            sd_error_details = sd_error_details | (word(1) << SD_COMMAND_CRC_ERROR)
            sd_has_error = 1
            crc7_value = 0xFF  -- Use invalid CRC on error
         end if
      end if
      
      x = crc7_value
   else
      -- Original library behavior for backwards compatibility
      -- send a valid CRC byte only for set idle command
      -- right bit must always be 1 (stop bit)
      if command == SD_GO_IDLE_STATE then
         x = 0x95
      elsif command == SD_SEND_IF_COND then
         x = 0x87
      else
         x = 0xFF
      end if
   end if

   command = command | 64          -- left bits must be 01 (start bits)

   spi_master = 0xFF            -- send 8 clock pulses

   spi_master = command         -- send the command
   spi_master = parameters[3]   -- send command parameters
   spi_master = parameters[2]   -- send command parameters
   spi_master = parameters[1]   -- send command parameters
   spi_master = parameters[0]   -- send command parameters

   -- Send CRC7 value (calculated or hardcoded)
   spi_master = x

   -- Get a response from the card after each command
   var word step = 0
   forever loop
      response = spi_master
      if response != 0xFF then
         exit loop
      end if

      -- can take up to 100ms, but reduce timeout for faster error detection
      step = step + 1
      if step == 2500 then  -- Reduced from 5000 for faster timeout
         exit loop
      end if
   end loop
end procedure

--------------------------------------------------------------------------------
-- check if the sd card is ready after last command.
-- returns 1 if ready, 0 if not ready.
--------------------------------------------------------------------------------
function sd_ready() return byte is
   var byte response = 1
   var byte step = 0

   while response != 0 loop   -- wait till last command has been completed
      send_command(SD_SEND_OP_COND,0, response)

      -- check for timeout
      if step == 100 then
         sd_error_details = sd_error_details | (word(1) << SD_TIMED_OUT)
         sd_has_error = 1
         return 0
      end if
      step = step + 1
   end loop
   return 1
end function

;   --------------------------------------------------------------------------------
;   -- send SD_READ_IF_COND command
;   --------------------------------------------------------------------------------
;   function sd_read_if_cond() return byte is
;      sd_enable()   -- enable the sd card
;
;      var byte response,x
;      send_command(SD_SEND_IF_COND, 0x1AA, response)
;      print_byte_hex(serial_data,response)
;
;      print_byte_hex(serial_data,spi_master)
;      print_byte_hex(serial_data,spi_master)
;      print_byte_hex(serial_data,spi_master)
;      print_byte_hex(serial_data,spi_master)
;
;      ;x = spi_master
;      ;x = spi_master
;      ;x = spi_master
;      ;x = spi_master
;
;      spi_master = 0xFF            -- send 8 clock pulses
;
;      sd_disable   -- disable the sd card
;
;      return response
;   end function

--------------------------------------------------------------------------------
-- Check if SD card exists
--------------------------------------------------------------------------------
function sd_is_inserted() return bit is
   sd_has_error = 0
   sd_error_details = 0
   var byte response = 0           -- shows if sd card init is ok

   if defined(sd_force_spi_mode) == true then
      sd_force_spi_mode()
   end if

   pin_sdo = low
   pin_sdi = low
   pin_sck = low

   -- steps to set sd card to use SPI
   _usec_delay(1_000)        -- delay
   sd_disable     -- chip select high

   for 11 loop
      spi_master = 0xFF    -- send clock pulses (0xFF 10 times)
   end loop

   -- try to contact the sd card
   var byte count1 = 0
   while (response == 0) loop -- try 100 times
      _usec_delay(1000)      -- delay 1ms
      sd_enable()   -- enable the sd card
      _usec_delay(255)      -- delay 255us
      send_command(SD_GO_IDLE_STATE,0,response) -- command 0, Resets card to idle state, get a response
      sd_disable  -- disable the sd card
      count1 = count1 + 1    -- increment count
      if count1 == 100 then
         sd_error = SD_INIT_FAILURE

         return
      end if
   end loop

   if response == 0xFF then
      sd_error = SD_DEVICE_NOT_FOUND
      sd_error = SD_INIT_FAILURE

      sd_number_of_sectors = 0
      sd_has_init = 0

      -- set pins back to start state.
      pin_sdo = low
      pin_sdi = low
      pin_sck = low
      sd_disable

      return 0
   else

      if sd_has_init == 0 then
         sd_init()
         ;serial_data = "%"
      else
         ;var byte ignore_return_value = sd_ready() -- wait till card is ready
         ;serial_data = "*"
      end if

      return 1
   end if

end function

--------------------------------------------------------------------------------
-- Enhanced SD card initialization with improved error handling and reporting
--------------------------------------------------------------------------------
procedure sd_init() is
   var byte response = 0 -- sd_card command response

   if defined(USE_CRC) then
      -- Initialize CRC lookup tables for faster calculation
      crc_init()
   end if
   
   sd_has_init = 1
   if !sd_is_inserted() then
      return
   end if


   sd_number_of_sectors = 0

   -- send SD_SEND_IF_COND command
   sd_enable()   -- enable the sd card
   send_command(SD_SEND_IF_COND, 0x1AA, response)
   ;print_byte_hex(serial_data,response)

   var bit illegal_command at response : SD_ILLEGAL_COMMAND
   if illegal_command == TRUE then -- SD CARD SPEC 1
      ;print_string(serial_data, "STANDARD CAPACITY\r\n")
      sd_card_type = SD_STANDARD_CAPACITY

      sd_enable()  -- enable the sd card

      if !sd_ready() == 0 then            -- wait till sd card is ready
         sd_error_details = sd_error_details | (word(1) << SD_INIT_FAILURE)
         sd_has_error = 1
         return
      end if

      sd_disable -- disable the sd card
      sd_get_number_of_sectors()

      return
   else -- SD CARD SPEC 2
      ;print_byte_hex(serial_data,spi_master)
      ;print_byte_hex(serial_data,spi_master)
      ;print_byte_hex(serial_data,spi_master)
      ;print_byte_hex(serial_data,spi_master)
      response = spi_master
      response = spi_master
      response = spi_master  ;0x01
      response = spi_master  ;0xAA
      sd_disable    -- disable the sd card

      if response == 0xAA then
         sd_enable()  -- enable the sd card

         -- check if it has completed init
         forever loop
            send_command(SD_APP_CMD, 0, response)
            send_command(SD_SD_APP_OP_COND,0x40_00_00_00, response)
            if response == 0 then
               exit loop
            end if
         end loop

         -- read OCR here
         send_command(SD_READ_OCR,0, response)
         if (spi_master & 0x40) > 0 then
            sd_card_type = SD_HIGH_CAPACITY
            ;print_string(serial_data, "HIGH CAPACITY\r\n")
         else -- sd card spec 2 standard capacity??
            sd_card_type = SD_STANDARD_CAPACITY
            ;print_string(serial_data, "STANDARD CAPACITY\r\n")
         end if
         response = spi_master
         response = spi_master
         response = spi_master

         -- set block size to 512
         send_command(SD_SET_BLOCKLEN,512, response)


         if !sd_ready() == 0 then            -- wait till sd card is ready
            sd_error_details = sd_error_details | (word(1) << SD_TIMED_OUT)
            sd_has_error = 1
         end if

         sd_disable  -- disable the sd card
      else
         sd_has_error = TRUE
         sd_disable  -- disable the sd card
         sd_get_number_of_sectors()
         return
      end if
   end if
   sd_get_number_of_sectors()
end procedure

--------------------------------------------------------------------------------
-- set the sd card to idle state
--------------------------------------------------------------------------------
procedure sd_set_idle() is
   sd_enable()  -- enable the sd card
   var byte response = 0
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
   sd_disable  -- disable the sd card
end procedure

--------------------------------------------------------------------------------
-- tell sd card you will be reading data from a specified sector
-- do not interupt read process by switching to another spi component
--------------------------------------------------------------------------------
procedure  sd_start_read(dword in address) is
   sd_sector_select = address

   -- put spi into mode
   if defined(sd_force_spi_mode) == true then
      sd_force_spi_mode()
   end if

   var byte response
   sd_enable()  -- enable the sd card
   if sd_card_type == SD_STANDARD_CAPACITY then
      address = address * SD_BYTE_PER_SECTOR -- make sd card sector addressable, sd cards are normally byte addressable.
   end if

   send_command(SD_READ_MULTIPLE_BLOCK,address,response) -- send read multi block command, ignore response.
   sd_byte_count = 0
   sd_sector_count = 0     -- reset count
end procedure


function sd_read_write_next_ready(byte in read_write) return byte is
   if sd_byte_count == 0 then            -- beginning of sector read
      var word count1 = 0
      while spi_master != 0xFE loop      -- wait till data is ready to read
         if count1 == 10000 then
            if read_write == SD_READ then
               sd_error = SD_READ_ERROR
            else
               sd_error = SD_WRITE_ERROR
            end if
            return 0
         end if
         count1 = count1 + 1
      end loop
   end if
   return 1
end function

--------------------------------------------------------------------------------
-- read 1 bytes from the sd card (pseudo var)
--------------------------------------------------------------------------------
function sd_data_byte'get() return byte is
   var byte x, data_byte

   if sd_read_write_next_ready(SD_READ) == FALSE then return end if -- return on read error

   data_byte = spi_master                -- get data byte

   sd_byte_count = sd_byte_count + 1     -- increment byte_count
   if sd_byte_count == SD_BYTE_PER_SECTOR then          -- end of sector read
      sd_byte_count = 0
      sd_sector_count = sd_sector_count + 1 -- increment sector number
      
      -- Read CRC16 for data block (discard for individual byte reads)
      x = spi_master                     -- get CRC16 high byte
      x = spi_master                     -- get CRC16 low byte
   end if

   return data_byte
end function



--------------------------------------------------------------------------------
-- tell sd card you are finished reading
-- needed to be the same as other mass media libs
--------------------------------------------------------------------------------
procedure sd_stop_read() is
   sd_set_idle()
   sd_disable  -- disable the sd card
end procedure

--------------------------------------------------------------------------------
-- send a read pulse to the sd card, go 1 bytes forward in current sector.
--------------------------------------------------------------------------------
procedure sd_read_pulse_byte(word in count1) is
   var byte x
   for count1 loop           -- loop specified number of times
      x = sd_data_byte       -- do a data read and ignore the incomming data
   end loop
end procedure

--------------------------------------------------------------------------------
-- tell sd card you will be writing data to a specified sector
-- must write 1 sector at a time, SD_BYTE_PER_SECTOR bytes
-- do not interupt write process by switching to another spi component
--------------------------------------------------------------------------------
procedure sd_start_write(dword in address) is

   -- put spi into mode
   if defined(sd_force_spi_mode) == true then
      sd_force_spi_mode()
   end if

   sd_toggle()
   
   sd_sector_select = address  -- Set the current sector tracking variable
   
   if sd_card_type == SD_STANDARD_CAPACITY then
      address = address * SD_BYTE_PER_SECTOR -- make sd card sector addressable, sd cards are normally byte addressable.
   end if
   
   var byte response
   send_command(SD_WRITE_MULTIPLE_BLOCK,address,response) -- send read multi block command, ignore response.

   sd_byte_count = 0       -- reset count
   sd_sector_count = 0     -- reset count

end procedure

--------------------------------------------------------------------------------
-- write 1 byte to the sd card (pseudo var)
--------------------------------------------------------------------------------
procedure sd_data_byte'put(byte in data_byte) is
   var byte x

   if sd_byte_count == 0 then    -- beginning of sector write
      spi_master = 0xFC       -- send "stop transmission token" write multiple command
      ;spi_master = 0xFE      -- send "stop transmission token" for write single command
   end if

   spi_master = data_byte     -- send data byte

   sd_byte_count = sd_byte_count + 1  -- increment byte count

   if sd_byte_count == SD_BYTE_PER_SECTOR then -- end of sector write
      sd_byte_count = 0
      sd_sector_count = sd_sector_count + 1 -- increment sector count

      spi_master = 0xFF  -- send CRC16 high byte (not calculated for individual bytes)
      spi_master = 0xFF  -- send CRC16 low byte (not calculated for individual bytes)

      x = spi_master   -- wait for a response
      while x == 0 loop
         x = spi_master
      end loop
      -- response = 010 = data accepted
      -- response = 101 = crc error
      -- response = 110 = write error

      x = spi_master   -- wait for sd card to become ready
      while x != 0xFF loop
         x = spi_master
      end loop
   end if
end procedure

--------------------------------------------------------------------------------
-- write till sector is finished with input byte
-- data does not actually get written till you get to the end of the sector
--------------------------------------------------------------------------------
procedure sd_write_to_sector_end(byte in input_byte) is
   if !(sd_byte_count == 0) then
      var byte x
      var word y
      y = SD_BYTE_PER_SECTOR - sd_byte_count
      for y loop
         sd_data_byte = input_byte -- write 2 bytes, 0's as data
      end loop

      sd_byte_count = 0
      sd_sector_count = sd_sector_count + 1 -- increment sector count

      spi_master = 0xFF  -- send CRC16 high byte (not calculated for individual bytes)
      spi_master = 0xFF  -- send CRC16 low byte (not calculated for individual bytes)

      x = spi_master   -- wait for a response
      while x == 0 loop
         x = spi_master
      end loop
      -- response = 010 = data accepted
      -- response = 101 = crc error
      -- response = 110 = write error

      x = spi_master   -- wait for sd card to become ready
      while x != 0xFF loop
         x = spi_master
      end loop
   end if
end procedure

--------------------------------------------------------------------------------
-- tell sd card you are finished writing
--------------------------------------------------------------------------------
procedure sd_stop_write() is
   var byte response
   sd_write_to_sector_end(0) -- writes 0's till end of sector

   spi_master = 0xFD -- send "stop transmission token"

   send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission

   if SD_DELAY_AFTER_WRITE == TRUE then ; for trouble cards
      _usec_delay (50_000)
   else
      for 50000 loop ; use this in most cases
         send_command(SD_STOP_TRANSMISSION,0,response) -- stop current transmission
         if response != 0 then
            exit loop
         end if
      end loop
   end if
   sd_disable  -- disable the sd card
end procedure

;--------------------------------------------------------------------------------
;-- send a write pulse to the sd card by writing 2 bytes, 0's as data
;--------------------------------------------------------------------------------
procedure sd_write_pulse(byte in count1) is
   _warn "This procedure is obsolete. Please use sd_write_pulse_byte()"
   for count1 loop
      sd_data_byte = 0
      sd_data_byte = 0
   end loop
end procedure

;--------------------------------------------------------------------------------
;-- send a write pulse to the sd card by writing 1 bytes, 0 as data
;--------------------------------------------------------------------------------
procedure sd_write_pulse_byte(word in count1) is
   for count1 loop
      sd_data_byte = 0
   end loop
end procedure

---------------------------------------------------------------------------
-- define the sector buffer. Can be read as sd_sector_buffer[0-511]
-- Note: sd_sector_buffer is now a large_array_6, so direct access is used
---------------------------------------------------------------------------

---------------------------------------------------------------------------
-- Extra speed read procedure
---------------------------------------------------------------------------
procedure _sd_read_512() is
   sd_sector_buffer[0] = spi_master
   sd_sector_buffer[1] = spi_master
   sd_sector_buffer[2] = spi_master
   sd_sector_buffer[3] = spi_master
   sd_sector_buffer[4] = spi_master
   sd_sector_buffer[5] = spi_master
   sd_sector_buffer[6] = spi_master
   sd_sector_buffer[7] = spi_master
   sd_sector_buffer[8] = spi_master
   sd_sector_buffer[9] = spi_master
   sd_sector_buffer[10] = spi_master
   sd_sector_buffer[11] = spi_master
   sd_sector_buffer[12] = spi_master
   sd_sector_buffer[13] = spi_master
   sd_sector_buffer[14] = spi_master
   sd_sector_buffer[15] = spi_master
   sd_sector_buffer[16] = spi_master
   sd_sector_buffer[17] = spi_master
   sd_sector_buffer[18] = spi_master
   sd_sector_buffer[19] = spi_master
   sd_sector_buffer[20] = spi_master
   sd_sector_buffer[21] = spi_master
   sd_sector_buffer[22] = spi_master
   sd_sector_buffer[23] = spi_master
   sd_sector_buffer[24] = spi_master
   sd_sector_buffer[25] = spi_master
   sd_sector_buffer[26] = spi_master
   sd_sector_buffer[27] = spi_master
   sd_sector_buffer[28] = spi_master
   sd_sector_buffer[29] = spi_master
   sd_sector_buffer[30] = spi_master
   sd_sector_buffer[31] = spi_master
   sd_sector_buffer[32] = spi_master
   sd_sector_buffer[33] = spi_master
   sd_sector_buffer[34] = spi_master
   sd_sector_buffer[35] = spi_master
   sd_sector_buffer[36] = spi_master
   sd_sector_buffer[37] = spi_master
   sd_sector_buffer[38] = spi_master
   sd_sector_buffer[39] = spi_master
   sd_sector_buffer[40] = spi_master
   sd_sector_buffer[41] = spi_master
   sd_sector_buffer[42] = spi_master
   sd_sector_buffer[43] = spi_master
   sd_sector_buffer[44] = spi_master
   sd_sector_buffer[45] = spi_master
   sd_sector_buffer[46] = spi_master
   sd_sector_buffer[47] = spi_master
   sd_sector_buffer[48] = spi_master
   sd_sector_buffer[49] = spi_master
   sd_sector_buffer[50] = spi_master
   sd_sector_buffer[51] = spi_master
   sd_sector_buffer[52] = spi_master
   sd_sector_buffer[53] = spi_master
   sd_sector_buffer[54] = spi_master
   sd_sector_buffer[55] = spi_master
   sd_sector_buffer[56] = spi_master
   sd_sector_buffer[57] = spi_master
   sd_sector_buffer[58] = spi_master
   sd_sector_buffer[59] = spi_master
   sd_sector_buffer[60] = spi_master
   sd_sector_buffer[61] = spi_master
   sd_sector_buffer[62] = spi_master
   sd_sector_buffer[63] = spi_master
   sd_sector_buffer[64] = spi_master
   sd_sector_buffer[65] = spi_master
   sd_sector_buffer[66] = spi_master
   sd_sector_buffer[67] = spi_master
   sd_sector_buffer[68] = spi_master
   sd_sector_buffer[69] = spi_master
   sd_sector_buffer[70] = spi_master
   sd_sector_buffer[71] = spi_master
   sd_sector_buffer[72] = spi_master
   sd_sector_buffer[73] = spi_master
   sd_sector_buffer[74] = spi_master
   sd_sector_buffer[75] = spi_master
   sd_sector_buffer[76] = spi_master
   sd_sector_buffer[77] = spi_master
   sd_sector_buffer[78] = spi_master
   sd_sector_buffer[79] = spi_master
   sd_sector_buffer[80] = spi_master
   sd_sector_buffer[81] = spi_master
   sd_sector_buffer[82] = spi_master
   sd_sector_buffer[83] = spi_master
   sd_sector_buffer[84] = spi_master
   sd_sector_buffer[85] = spi_master
   sd_sector_buffer[86] = spi_master
   sd_sector_buffer[87] = spi_master
   sd_sector_buffer[88] = spi_master
   sd_sector_buffer[89] = spi_master
   sd_sector_buffer[90] = spi_master
   sd_sector_buffer[91] = spi_master
   sd_sector_buffer[92] = spi_master
   sd_sector_buffer[93] = spi_master
   sd_sector_buffer[94] = spi_master
   sd_sector_buffer[95] = spi_master
   sd_sector_buffer[96] = spi_master
   sd_sector_buffer[97] = spi_master
   sd_sector_buffer[98] = spi_master
   sd_sector_buffer[99] = spi_master
   sd_sector_buffer[100] = spi_master
   sd_sector_buffer[101] = spi_master
   sd_sector_buffer[102] = spi_master
   sd_sector_buffer[103] = spi_master
   sd_sector_buffer[104] = spi_master
   sd_sector_buffer[105] = spi_master
   sd_sector_buffer[106] = spi_master
   sd_sector_buffer[107] = spi_master
   sd_sector_buffer[108] = spi_master
   sd_sector_buffer[109] = spi_master
   sd_sector_buffer[110] = spi_master
   sd_sector_buffer[111] = spi_master
   sd_sector_buffer[112] = spi_master
   sd_sector_buffer[113] = spi_master
   sd_sector_buffer[114] = spi_master
   sd_sector_buffer[115] = spi_master
   sd_sector_buffer[116] = spi_master
   sd_sector_buffer[117] = spi_master
   sd_sector_buffer[118] = spi_master
   sd_sector_buffer[119] = spi_master
   sd_sector_buffer[120] = spi_master
   sd_sector_buffer[121] = spi_master
   sd_sector_buffer[122] = spi_master
   sd_sector_buffer[123] = spi_master
   sd_sector_buffer[124] = spi_master
   sd_sector_buffer[125] = spi_master
   sd_sector_buffer[126] = spi_master
   sd_sector_buffer[127] = spi_master
   sd_sector_buffer[128] = spi_master
   sd_sector_buffer[129] = spi_master
   sd_sector_buffer[130] = spi_master
   sd_sector_buffer[131] = spi_master
   sd_sector_buffer[132] = spi_master
   sd_sector_buffer[133] = spi_master
   sd_sector_buffer[134] = spi_master
   sd_sector_buffer[135] = spi_master
   sd_sector_buffer[136] = spi_master
   sd_sector_buffer[137] = spi_master
   sd_sector_buffer[138] = spi_master
   sd_sector_buffer[139] = spi_master
   sd_sector_buffer[140] = spi_master
   sd_sector_buffer[141] = spi_master
   sd_sector_buffer[142] = spi_master
   sd_sector_buffer[143] = spi_master
   sd_sector_buffer[144] = spi_master
   sd_sector_buffer[145] = spi_master
   sd_sector_buffer[146] = spi_master
   sd_sector_buffer[147] = spi_master
   sd_sector_buffer[148] = spi_master
   sd_sector_buffer[149] = spi_master
   sd_sector_buffer[150] = spi_master
   sd_sector_buffer[151] = spi_master
   sd_sector_buffer[152] = spi_master
   sd_sector_buffer[153] = spi_master
   sd_sector_buffer[154] = spi_master
   sd_sector_buffer[155] = spi_master
   sd_sector_buffer[156] = spi_master
   sd_sector_buffer[157] = spi_master
   sd_sector_buffer[158] = spi_master
   sd_sector_buffer[159] = spi_master
   sd_sector_buffer[160] = spi_master
   sd_sector_buffer[161] = spi_master
   sd_sector_buffer[162] = spi_master
   sd_sector_buffer[163] = spi_master
   sd_sector_buffer[164] = spi_master
   sd_sector_buffer[165] = spi_master
   sd_sector_buffer[166] = spi_master
   sd_sector_buffer[167] = spi_master
   sd_sector_buffer[168] = spi_master
   sd_sector_buffer[169] = spi_master
   sd_sector_buffer[170] = spi_master
   sd_sector_buffer[171] = spi_master
   sd_sector_buffer[172] = spi_master
   sd_sector_buffer[173] = spi_master
   sd_sector_buffer[174] = spi_master
   sd_sector_buffer[175] = spi_master
   sd_sector_buffer[176] = spi_master
   sd_sector_buffer[177] = spi_master
   sd_sector_buffer[178] = spi_master
   sd_sector_buffer[179] = spi_master
   sd_sector_buffer[180] = spi_master
   sd_sector_buffer[181] = spi_master
   sd_sector_buffer[182] = spi_master
   sd_sector_buffer[183] = spi_master
   sd_sector_buffer[184] = spi_master
   sd_sector_buffer[185] = spi_master
   sd_sector_buffer[186] = spi_master
   sd_sector_buffer[187] = spi_master
   sd_sector_buffer[188] = spi_master
   sd_sector_buffer[189] = spi_master
   sd_sector_buffer[190] = spi_master
   sd_sector_buffer[191] = spi_master
   sd_sector_buffer[192] = spi_master
   sd_sector_buffer[193] = spi_master
   sd_sector_buffer[194] = spi_master
   sd_sector_buffer[195] = spi_master
   sd_sector_buffer[196] = spi_master
   sd_sector_buffer[197] = spi_master
   sd_sector_buffer[198] = spi_master
   sd_sector_buffer[199] = spi_master
   sd_sector_buffer[200] = spi_master
   sd_sector_buffer[201] = spi_master
   sd_sector_buffer[202] = spi_master
   sd_sector_buffer[203] = spi_master
   sd_sector_buffer[204] = spi_master
   sd_sector_buffer[205] = spi_master
   sd_sector_buffer[206] = spi_master
   sd_sector_buffer[207] = spi_master
   sd_sector_buffer[208] = spi_master
   sd_sector_buffer[209] = spi_master
   sd_sector_buffer[210] = spi_master
   sd_sector_buffer[211] = spi_master
   sd_sector_buffer[212] = spi_master
   sd_sector_buffer[213] = spi_master
   sd_sector_buffer[214] = spi_master
   sd_sector_buffer[215] = spi_master
   sd_sector_buffer[216] = spi_master
   sd_sector_buffer[217] = spi_master
   sd_sector_buffer[218] = spi_master
   sd_sector_buffer[219] = spi_master
   sd_sector_buffer[220] = spi_master
   sd_sector_buffer[221] = spi_master
   sd_sector_buffer[222] = spi_master
   sd_sector_buffer[223] = spi_master
   sd_sector_buffer[224] = spi_master
   sd_sector_buffer[225] = spi_master
   sd_sector_buffer[226] = spi_master
   sd_sector_buffer[227] = spi_master
   sd_sector_buffer[228] = spi_master
   sd_sector_buffer[229] = spi_master
   sd_sector_buffer[230] = spi_master
   sd_sector_buffer[231] = spi_master
   sd_sector_buffer[232] = spi_master
   sd_sector_buffer[233] = spi_master
   sd_sector_buffer[234] = spi_master
   sd_sector_buffer[235] = spi_master
   sd_sector_buffer[236] = spi_master
   sd_sector_buffer[237] = spi_master
   sd_sector_buffer[238] = spi_master
   sd_sector_buffer[239] = spi_master
   sd_sector_buffer[240] = spi_master
   sd_sector_buffer[241] = spi_master
   sd_sector_buffer[242] = spi_master
   sd_sector_buffer[243] = spi_master
   sd_sector_buffer[244] = spi_master
   sd_sector_buffer[245] = spi_master
   sd_sector_buffer[246] = spi_master
   sd_sector_buffer[247] = spi_master
   sd_sector_buffer[248] = spi_master
   sd_sector_buffer[249] = spi_master
   sd_sector_buffer[250] = spi_master
   sd_sector_buffer[251] = spi_master
   sd_sector_buffer[252] = spi_master
   sd_sector_buffer[253] = spi_master
   sd_sector_buffer[254] = spi_master
   sd_sector_buffer[255] = spi_master
   sd_sector_buffer[256] = spi_master
   sd_sector_buffer[257] = spi_master
   sd_sector_buffer[258] = spi_master
   sd_sector_buffer[259] = spi_master
   sd_sector_buffer[260] = spi_master
   sd_sector_buffer[261] = spi_master
   sd_sector_buffer[262] = spi_master
   sd_sector_buffer[263] = spi_master
   sd_sector_buffer[264] = spi_master
   sd_sector_buffer[265] = spi_master
   sd_sector_buffer[266] = spi_master
   sd_sector_buffer[267] = spi_master
   sd_sector_buffer[268] = spi_master
   sd_sector_buffer[269] = spi_master
   sd_sector_buffer[270] = spi_master
   sd_sector_buffer[271] = spi_master
   sd_sector_buffer[272] = spi_master
   sd_sector_buffer[273] = spi_master
   sd_sector_buffer[274] = spi_master
   sd_sector_buffer[275] = spi_master
   sd_sector_buffer[276] = spi_master
   sd_sector_buffer[277] = spi_master
   sd_sector_buffer[278] = spi_master
   sd_sector_buffer[279] = spi_master
   sd_sector_buffer[280] = spi_master
   sd_sector_buffer[281] = spi_master
   sd_sector_buffer[282] = spi_master
   sd_sector_buffer[283] = spi_master
   sd_sector_buffer[284] = spi_master
   sd_sector_buffer[285] = spi_master
   sd_sector_buffer[286] = spi_master
   sd_sector_buffer[287] = spi_master
   sd_sector_buffer[288] = spi_master
   sd_sector_buffer[289] = spi_master
   sd_sector_buffer[290] = spi_master
   sd_sector_buffer[291] = spi_master
   sd_sector_buffer[292] = spi_master
   sd_sector_buffer[293] = spi_master
   sd_sector_buffer[294] = spi_master
   sd_sector_buffer[295] = spi_master
   sd_sector_buffer[296] = spi_master
   sd_sector_buffer[297] = spi_master
   sd_sector_buffer[298] = spi_master
   sd_sector_buffer[299] = spi_master
   sd_sector_buffer[300] = spi_master
   sd_sector_buffer[301] = spi_master
   sd_sector_buffer[302] = spi_master
   sd_sector_buffer[303] = spi_master
   sd_sector_buffer[304] = spi_master
   sd_sector_buffer[305] = spi_master
   sd_sector_buffer[306] = spi_master
   sd_sector_buffer[307] = spi_master
   sd_sector_buffer[308] = spi_master
   sd_sector_buffer[309] = spi_master
   sd_sector_buffer[310] = spi_master
   sd_sector_buffer[311] = spi_master
   sd_sector_buffer[312] = spi_master
   sd_sector_buffer[313] = spi_master
   sd_sector_buffer[314] = spi_master
   sd_sector_buffer[315] = spi_master
   sd_sector_buffer[316] = spi_master
   sd_sector_buffer[317] = spi_master
   sd_sector_buffer[318] = spi_master
   sd_sector_buffer[319] = spi_master
   sd_sector_buffer[320] = spi_master
   sd_sector_buffer[321] = spi_master
   sd_sector_buffer[322] = spi_master
   sd_sector_buffer[323] = spi_master
   sd_sector_buffer[324] = spi_master
   sd_sector_buffer[325] = spi_master
   sd_sector_buffer[326] = spi_master
   sd_sector_buffer[327] = spi_master
   sd_sector_buffer[328] = spi_master
   sd_sector_buffer[329] = spi_master
   sd_sector_buffer[330] = spi_master
   sd_sector_buffer[331] = spi_master
   sd_sector_buffer[332] = spi_master
   sd_sector_buffer[333] = spi_master
   sd_sector_buffer[334] = spi_master
   sd_sector_buffer[335] = spi_master
   sd_sector_buffer[336] = spi_master
   sd_sector_buffer[337] = spi_master
   sd_sector_buffer[338] = spi_master
   sd_sector_buffer[339] = spi_master
   sd_sector_buffer[340] = spi_master
   sd_sector_buffer[341] = spi_master
   sd_sector_buffer[342] = spi_master
   sd_sector_buffer[343] = spi_master
   sd_sector_buffer[344] = spi_master
   sd_sector_buffer[345] = spi_master
   sd_sector_buffer[346] = spi_master
   sd_sector_buffer[347] = spi_master
   sd_sector_buffer[348] = spi_master
   sd_sector_buffer[349] = spi_master
   sd_sector_buffer[350] = spi_master
   sd_sector_buffer[351] = spi_master
   sd_sector_buffer[352] = spi_master
   sd_sector_buffer[353] = spi_master
   sd_sector_buffer[354] = spi_master
   sd_sector_buffer[355] = spi_master
   sd_sector_buffer[356] = spi_master
   sd_sector_buffer[357] = spi_master
   sd_sector_buffer[358] = spi_master
   sd_sector_buffer[359] = spi_master
   sd_sector_buffer[360] = spi_master
   sd_sector_buffer[361] = spi_master
   sd_sector_buffer[362] = spi_master
   sd_sector_buffer[363] = spi_master
   sd_sector_buffer[364] = spi_master
   sd_sector_buffer[365] = spi_master
   sd_sector_buffer[366] = spi_master
   sd_sector_buffer[367] = spi_master
   sd_sector_buffer[368] = spi_master
   sd_sector_buffer[369] = spi_master
   sd_sector_buffer[370] = spi_master
   sd_sector_buffer[371] = spi_master
   sd_sector_buffer[372] = spi_master
   sd_sector_buffer[373] = spi_master
   sd_sector_buffer[374] = spi_master
   sd_sector_buffer[375] = spi_master
   sd_sector_buffer[376] = spi_master
   sd_sector_buffer[377] = spi_master
   sd_sector_buffer[378] = spi_master
   sd_sector_buffer[379] = spi_master
   sd_sector_buffer[380] = spi_master
   sd_sector_buffer[381] = spi_master
   sd_sector_buffer[382] = spi_master
   sd_sector_buffer[383] = spi_master
   sd_sector_buffer[384] = spi_master
   sd_sector_buffer[385] = spi_master
   sd_sector_buffer[386] = spi_master
   sd_sector_buffer[387] = spi_master
   sd_sector_buffer[388] = spi_master
   sd_sector_buffer[389] = spi_master
   sd_sector_buffer[390] = spi_master
   sd_sector_buffer[391] = spi_master
   sd_sector_buffer[392] = spi_master
   sd_sector_buffer[393] = spi_master
   sd_sector_buffer[394] = spi_master
   sd_sector_buffer[395] = spi_master
   sd_sector_buffer[396] = spi_master
   sd_sector_buffer[397] = spi_master
   sd_sector_buffer[398] = spi_master
   sd_sector_buffer[399] = spi_master
   sd_sector_buffer[400] = spi_master
   sd_sector_buffer[401] = spi_master
   sd_sector_buffer[402] = spi_master
   sd_sector_buffer[403] = spi_master
   sd_sector_buffer[404] = spi_master
   sd_sector_buffer[405] = spi_master
   sd_sector_buffer[406] = spi_master
   sd_sector_buffer[407] = spi_master
   sd_sector_buffer[408] = spi_master
   sd_sector_buffer[409] = spi_master
   sd_sector_buffer[410] = spi_master
   sd_sector_buffer[411] = spi_master
   sd_sector_buffer[412] = spi_master
   sd_sector_buffer[413] = spi_master
   sd_sector_buffer[414] = spi_master
   sd_sector_buffer[415] = spi_master
   sd_sector_buffer[416] = spi_master
   sd_sector_buffer[417] = spi_master
   sd_sector_buffer[418] = spi_master
   sd_sector_buffer[419] = spi_master
   sd_sector_buffer[420] = spi_master
   sd_sector_buffer[421] = spi_master
   sd_sector_buffer[422] = spi_master
   sd_sector_buffer[423] = spi_master
   sd_sector_buffer[424] = spi_master
   sd_sector_buffer[425] = spi_master
   sd_sector_buffer[426] = spi_master
   sd_sector_buffer[427] = spi_master
   sd_sector_buffer[428] = spi_master
   sd_sector_buffer[429] = spi_master
   sd_sector_buffer[430] = spi_master
   sd_sector_buffer[431] = spi_master
   sd_sector_buffer[432] = spi_master
   sd_sector_buffer[433] = spi_master
   sd_sector_buffer[434] = spi_master
   sd_sector_buffer[435] = spi_master
   sd_sector_buffer[436] = spi_master
   sd_sector_buffer[437] = spi_master
   sd_sector_buffer[438] = spi_master
   sd_sector_buffer[439] = spi_master
   sd_sector_buffer[440] = spi_master
   sd_sector_buffer[441] = spi_master
   sd_sector_buffer[442] = spi_master
   sd_sector_buffer[443] = spi_master
   sd_sector_buffer[444] = spi_master
   sd_sector_buffer[445] = spi_master
   sd_sector_buffer[446] = spi_master
   sd_sector_buffer[447] = spi_master
   sd_sector_buffer[448] = spi_master
   sd_sector_buffer[449] = spi_master
   sd_sector_buffer[450] = spi_master
   sd_sector_buffer[451] = spi_master
   sd_sector_buffer[452] = spi_master
   sd_sector_buffer[453] = spi_master
   sd_sector_buffer[454] = spi_master
   sd_sector_buffer[455] = spi_master
   sd_sector_buffer[456] = spi_master
   sd_sector_buffer[457] = spi_master
   sd_sector_buffer[458] = spi_master
   sd_sector_buffer[459] = spi_master
   sd_sector_buffer[460] = spi_master
   sd_sector_buffer[461] = spi_master
   sd_sector_buffer[462] = spi_master
   sd_sector_buffer[463] = spi_master
   sd_sector_buffer[464] = spi_master
   sd_sector_buffer[465] = spi_master
   sd_sector_buffer[466] = spi_master
   sd_sector_buffer[467] = spi_master
   sd_sector_buffer[468] = spi_master
   sd_sector_buffer[469] = spi_master
   sd_sector_buffer[470] = spi_master
   sd_sector_buffer[471] = spi_master
   sd_sector_buffer[472] = spi_master
   sd_sector_buffer[473] = spi_master
   sd_sector_buffer[474] = spi_master
   sd_sector_buffer[475] = spi_master
   sd_sector_buffer[476] = spi_master
   sd_sector_buffer[477] = spi_master
   sd_sector_buffer[478] = spi_master
   sd_sector_buffer[479] = spi_master
   sd_sector_buffer[480] = spi_master
   sd_sector_buffer[481] = spi_master
   sd_sector_buffer[482] = spi_master
   sd_sector_buffer[483] = spi_master
   sd_sector_buffer[484] = spi_master
   sd_sector_buffer[485] = spi_master
   sd_sector_buffer[486] = spi_master
   sd_sector_buffer[487] = spi_master
   sd_sector_buffer[488] = spi_master
   sd_sector_buffer[489] = spi_master
   sd_sector_buffer[490] = spi_master
   sd_sector_buffer[491] = spi_master
   sd_sector_buffer[492] = spi_master
   sd_sector_buffer[493] = spi_master
   sd_sector_buffer[494] = spi_master
   sd_sector_buffer[495] = spi_master
   sd_sector_buffer[496] = spi_master
   sd_sector_buffer[497] = spi_master
   sd_sector_buffer[498] = spi_master
   sd_sector_buffer[499] = spi_master
   sd_sector_buffer[500] = spi_master
   sd_sector_buffer[501] = spi_master
   sd_sector_buffer[502] = spi_master
   sd_sector_buffer[503] = spi_master
   sd_sector_buffer[504] = spi_master
   sd_sector_buffer[505] = spi_master
   sd_sector_buffer[506] = spi_master
   sd_sector_buffer[507] = spi_master
   sd_sector_buffer[508] = spi_master
   sd_sector_buffer[509] = spi_master
   sd_sector_buffer[510] = spi_master
   sd_sector_buffer[511] = spi_master
end procedure

--------------------------------------------------------------------------------
-- Extra speed read procedure with CRC calculation
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-- Extra speed read procedure with CRC calculation
--------------------------------------------------------------------------------
if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
procedure _sd_read_512_crc() is
   sd_sector_buffer[0] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[0])
   sd_sector_buffer[1] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[1])
   sd_sector_buffer[2] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[2])
   sd_sector_buffer[3] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[3])
   sd_sector_buffer[4] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[4])
   sd_sector_buffer[5] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[5])
   sd_sector_buffer[6] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[6])
   sd_sector_buffer[7] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[7])
   sd_sector_buffer[8] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[8])
   sd_sector_buffer[9] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[9])
   sd_sector_buffer[10] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[10])
   sd_sector_buffer[11] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[11])
   sd_sector_buffer[12] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[12])
   sd_sector_buffer[13] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[13])
   sd_sector_buffer[14] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[14])
   sd_sector_buffer[15] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[15])
   sd_sector_buffer[16] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[16])
   sd_sector_buffer[17] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[17])
   sd_sector_buffer[18] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[18])
   sd_sector_buffer[19] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[19])
   sd_sector_buffer[20] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[20])
   sd_sector_buffer[21] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[21])
   sd_sector_buffer[22] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[22])
   sd_sector_buffer[23] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[23])
   sd_sector_buffer[24] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[24])
   sd_sector_buffer[25] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[25])
   sd_sector_buffer[26] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[26])
   sd_sector_buffer[27] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[27])
   sd_sector_buffer[28] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[28])
   sd_sector_buffer[29] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[29])
   sd_sector_buffer[30] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[30])
   sd_sector_buffer[31] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[31])
   sd_sector_buffer[32] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[32])
   sd_sector_buffer[33] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[33])
   sd_sector_buffer[34] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[34])
   sd_sector_buffer[35] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[35])
   sd_sector_buffer[36] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[36])
   sd_sector_buffer[37] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[37])
   sd_sector_buffer[38] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[38])
   sd_sector_buffer[39] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[39])
   sd_sector_buffer[40] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[40])
   sd_sector_buffer[41] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[41])
   sd_sector_buffer[42] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[42])
   sd_sector_buffer[43] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[43])
   sd_sector_buffer[44] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[44])
   sd_sector_buffer[45] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[45])
   sd_sector_buffer[46] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[46])
   sd_sector_buffer[47] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[47])
   sd_sector_buffer[48] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[48])
   sd_sector_buffer[49] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[49])
   sd_sector_buffer[50] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[50])
   sd_sector_buffer[51] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[51])
   sd_sector_buffer[52] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[52])
   sd_sector_buffer[53] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[53])
   sd_sector_buffer[54] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[54])
   sd_sector_buffer[55] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[55])
   sd_sector_buffer[56] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[56])
   sd_sector_buffer[57] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[57])
   sd_sector_buffer[58] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[58])
   sd_sector_buffer[59] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[59])
   sd_sector_buffer[60] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[60])
   sd_sector_buffer[61] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[61])
   sd_sector_buffer[62] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[62])
   sd_sector_buffer[63] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[63])
   sd_sector_buffer[64] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[64])
   sd_sector_buffer[65] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[65])
   sd_sector_buffer[66] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[66])
   sd_sector_buffer[67] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[67])
   sd_sector_buffer[68] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[68])
   sd_sector_buffer[69] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[69])
   sd_sector_buffer[70] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[70])
   sd_sector_buffer[71] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[71])
   sd_sector_buffer[72] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[72])
   sd_sector_buffer[73] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[73])
   sd_sector_buffer[74] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[74])
   sd_sector_buffer[75] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[75])
   sd_sector_buffer[76] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[76])
   sd_sector_buffer[77] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[77])
   sd_sector_buffer[78] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[78])
   sd_sector_buffer[79] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[79])
   sd_sector_buffer[80] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[80])
   sd_sector_buffer[81] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[81])
   sd_sector_buffer[82] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[82])
   sd_sector_buffer[83] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[83])
   sd_sector_buffer[84] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[84])
   sd_sector_buffer[85] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[85])
   sd_sector_buffer[86] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[86])
   sd_sector_buffer[87] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[87])
   sd_sector_buffer[88] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[88])
   sd_sector_buffer[89] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[89])
   sd_sector_buffer[90] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[90])
   sd_sector_buffer[91] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[91])
   sd_sector_buffer[92] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[92])
   sd_sector_buffer[93] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[93])
   sd_sector_buffer[94] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[94])
   sd_sector_buffer[95] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[95])
   sd_sector_buffer[96] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[96])
   sd_sector_buffer[97] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[97])
   sd_sector_buffer[98] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[98])
   sd_sector_buffer[99] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[99])
   sd_sector_buffer[100] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[100])
   sd_sector_buffer[101] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[101])
   sd_sector_buffer[102] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[102])
   sd_sector_buffer[103] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[103])
   sd_sector_buffer[104] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[104])
   sd_sector_buffer[105] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[105])
   sd_sector_buffer[106] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[106])
   sd_sector_buffer[107] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[107])
   sd_sector_buffer[108] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[108])
   sd_sector_buffer[109] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[109])
   sd_sector_buffer[110] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[110])
   sd_sector_buffer[111] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[111])
   sd_sector_buffer[112] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[112])
   sd_sector_buffer[113] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[113])
   sd_sector_buffer[114] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[114])
   sd_sector_buffer[115] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[115])
   sd_sector_buffer[116] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[116])
   sd_sector_buffer[117] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[117])
   sd_sector_buffer[118] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[118])
   sd_sector_buffer[119] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[119])
   sd_sector_buffer[120] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[120])
   sd_sector_buffer[121] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[121])
   sd_sector_buffer[122] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[122])
   sd_sector_buffer[123] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[123])
   sd_sector_buffer[124] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[124])
   sd_sector_buffer[125] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[125])
   sd_sector_buffer[126] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[126])
   sd_sector_buffer[127] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[127])
   sd_sector_buffer[128] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[128])
   sd_sector_buffer[129] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[129])
   sd_sector_buffer[130] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[130])
   sd_sector_buffer[131] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[131])
   sd_sector_buffer[132] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[132])
   sd_sector_buffer[133] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[133])
   sd_sector_buffer[134] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[134])
   sd_sector_buffer[135] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[135])
   sd_sector_buffer[136] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[136])
   sd_sector_buffer[137] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[137])
   sd_sector_buffer[138] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[138])
   sd_sector_buffer[139] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[139])
   sd_sector_buffer[140] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[140])
   sd_sector_buffer[141] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[141])
   sd_sector_buffer[142] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[142])
   sd_sector_buffer[143] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[143])
   sd_sector_buffer[144] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[144])
   sd_sector_buffer[145] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[145])
   sd_sector_buffer[146] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[146])
   sd_sector_buffer[147] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[147])
   sd_sector_buffer[148] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[148])
   sd_sector_buffer[149] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[149])
   sd_sector_buffer[150] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[150])
   sd_sector_buffer[151] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[151])
   sd_sector_buffer[152] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[152])
   sd_sector_buffer[153] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[153])
   sd_sector_buffer[154] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[154])
   sd_sector_buffer[155] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[155])
   sd_sector_buffer[156] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[156])
   sd_sector_buffer[157] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[157])
   sd_sector_buffer[158] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[158])
   sd_sector_buffer[159] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[159])
   sd_sector_buffer[160] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[160])
   sd_sector_buffer[161] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[161])
   sd_sector_buffer[162] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[162])
   sd_sector_buffer[163] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[163])
   sd_sector_buffer[164] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[164])
   sd_sector_buffer[165] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[165])
   sd_sector_buffer[166] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[166])
   sd_sector_buffer[167] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[167])
   sd_sector_buffer[168] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[168])
   sd_sector_buffer[169] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[169])
   sd_sector_buffer[170] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[170])
   sd_sector_buffer[171] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[171])
   sd_sector_buffer[172] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[172])
   sd_sector_buffer[173] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[173])
   sd_sector_buffer[174] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[174])
   sd_sector_buffer[175] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[175])
   sd_sector_buffer[176] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[176])
   sd_sector_buffer[177] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[177])
   sd_sector_buffer[178] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[178])
   sd_sector_buffer[179] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[179])
   sd_sector_buffer[180] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[180])
   sd_sector_buffer[181] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[181])
   sd_sector_buffer[182] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[182])
   sd_sector_buffer[183] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[183])
   sd_sector_buffer[184] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[184])
   sd_sector_buffer[185] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[185])
   sd_sector_buffer[186] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[186])
   sd_sector_buffer[187] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[187])
   sd_sector_buffer[188] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[188])
   sd_sector_buffer[189] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[189])
   sd_sector_buffer[190] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[190])
   sd_sector_buffer[191] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[191])
   sd_sector_buffer[192] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[192])
   sd_sector_buffer[193] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[193])
   sd_sector_buffer[194] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[194])
   sd_sector_buffer[195] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[195])
   sd_sector_buffer[196] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[196])
   sd_sector_buffer[197] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[197])
   sd_sector_buffer[198] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[198])
   sd_sector_buffer[199] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[199])
   sd_sector_buffer[200] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[200])
   sd_sector_buffer[201] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[201])
   sd_sector_buffer[202] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[202])
   sd_sector_buffer[203] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[203])
   sd_sector_buffer[204] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[204])
   sd_sector_buffer[205] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[205])
   sd_sector_buffer[206] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[206])
   sd_sector_buffer[207] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[207])
   sd_sector_buffer[208] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[208])
   sd_sector_buffer[209] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[209])
   sd_sector_buffer[210] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[210])
   sd_sector_buffer[211] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[211])
   sd_sector_buffer[212] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[212])
   sd_sector_buffer[213] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[213])
   sd_sector_buffer[214] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[214])
   sd_sector_buffer[215] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[215])
   sd_sector_buffer[216] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[216])
   sd_sector_buffer[217] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[217])
   sd_sector_buffer[218] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[218])
   sd_sector_buffer[219] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[219])
   sd_sector_buffer[220] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[220])
   sd_sector_buffer[221] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[221])
   sd_sector_buffer[222] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[222])
   sd_sector_buffer[223] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[223])
   sd_sector_buffer[224] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[224])
   sd_sector_buffer[225] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[225])
   sd_sector_buffer[226] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[226])
   sd_sector_buffer[227] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[227])
   sd_sector_buffer[228] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[228])
   sd_sector_buffer[229] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[229])
   sd_sector_buffer[230] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[230])
   sd_sector_buffer[231] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[231])
   sd_sector_buffer[232] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[232])
   sd_sector_buffer[233] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[233])
   sd_sector_buffer[234] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[234])
   sd_sector_buffer[235] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[235])
   sd_sector_buffer[236] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[236])
   sd_sector_buffer[237] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[237])
   sd_sector_buffer[238] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[238])
   sd_sector_buffer[239] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[239])
   sd_sector_buffer[240] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[240])
   sd_sector_buffer[241] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[241])
   sd_sector_buffer[242] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[242])
   sd_sector_buffer[243] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[243])
   sd_sector_buffer[244] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[244])
   sd_sector_buffer[245] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[245])
   sd_sector_buffer[246] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[246])
   sd_sector_buffer[247] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[247])
   sd_sector_buffer[248] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[248])
   sd_sector_buffer[249] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[249])
   sd_sector_buffer[250] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[250])
   sd_sector_buffer[251] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[251])
   sd_sector_buffer[252] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[252])
   sd_sector_buffer[253] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[253])
   sd_sector_buffer[254] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[254])
   sd_sector_buffer[255] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[255])
   sd_sector_buffer[256] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[256])
   sd_sector_buffer[257] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[257])
   sd_sector_buffer[258] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[258])
   sd_sector_buffer[259] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[259])
   sd_sector_buffer[260] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[260])
   sd_sector_buffer[261] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[261])
   sd_sector_buffer[262] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[262])
   sd_sector_buffer[263] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[263])
   sd_sector_buffer[264] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[264])
   sd_sector_buffer[265] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[265])
   sd_sector_buffer[266] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[266])
   sd_sector_buffer[267] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[267])
   sd_sector_buffer[268] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[268])
   sd_sector_buffer[269] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[269])
   sd_sector_buffer[270] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[270])
   sd_sector_buffer[271] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[271])
   sd_sector_buffer[272] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[272])
   sd_sector_buffer[273] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[273])
   sd_sector_buffer[274] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[274])
   sd_sector_buffer[275] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[275])
   sd_sector_buffer[276] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[276])
   sd_sector_buffer[277] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[277])
   sd_sector_buffer[278] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[278])
   sd_sector_buffer[279] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[279])
   sd_sector_buffer[280] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[280])
   sd_sector_buffer[281] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[281])
   sd_sector_buffer[282] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[282])
   sd_sector_buffer[283] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[283])
   sd_sector_buffer[284] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[284])
   sd_sector_buffer[285] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[285])
   sd_sector_buffer[286] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[286])
   sd_sector_buffer[287] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[287])
   sd_sector_buffer[288] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[288])
   sd_sector_buffer[289] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[289])
   sd_sector_buffer[290] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[290])
   sd_sector_buffer[291] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[291])
   sd_sector_buffer[292] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[292])
   sd_sector_buffer[293] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[293])
   sd_sector_buffer[294] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[294])
   sd_sector_buffer[295] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[295])
   sd_sector_buffer[296] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[296])
   sd_sector_buffer[297] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[297])
   sd_sector_buffer[298] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[298])
   sd_sector_buffer[299] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[299])
   sd_sector_buffer[300] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[300])
   sd_sector_buffer[301] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[301])
   sd_sector_buffer[302] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[302])
   sd_sector_buffer[303] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[303])
   sd_sector_buffer[304] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[304])
   sd_sector_buffer[305] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[305])
   sd_sector_buffer[306] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[306])
   sd_sector_buffer[307] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[307])
   sd_sector_buffer[308] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[308])
   sd_sector_buffer[309] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[309])
   sd_sector_buffer[310] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[310])
   sd_sector_buffer[311] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[311])
   sd_sector_buffer[312] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[312])
   sd_sector_buffer[313] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[313])
   sd_sector_buffer[314] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[314])
   sd_sector_buffer[315] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[315])
   sd_sector_buffer[316] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[316])
   sd_sector_buffer[317] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[317])
   sd_sector_buffer[318] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[318])
   sd_sector_buffer[319] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[319])
   sd_sector_buffer[320] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[320])
   sd_sector_buffer[321] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[321])
   sd_sector_buffer[322] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[322])
   sd_sector_buffer[323] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[323])
   sd_sector_buffer[324] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[324])
   sd_sector_buffer[325] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[325])
   sd_sector_buffer[326] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[326])
   sd_sector_buffer[327] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[327])
   sd_sector_buffer[328] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[328])
   sd_sector_buffer[329] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[329])
   sd_sector_buffer[330] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[330])
   sd_sector_buffer[331] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[331])
   sd_sector_buffer[332] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[332])
   sd_sector_buffer[333] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[333])
   sd_sector_buffer[334] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[334])
   sd_sector_buffer[335] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[335])
   sd_sector_buffer[336] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[336])
   sd_sector_buffer[337] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[337])
   sd_sector_buffer[338] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[338])
   sd_sector_buffer[339] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[339])
   sd_sector_buffer[340] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[340])
   sd_sector_buffer[341] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[341])
   sd_sector_buffer[342] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[342])
   sd_sector_buffer[343] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[343])
   sd_sector_buffer[344] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[344])
   sd_sector_buffer[345] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[345])
   sd_sector_buffer[346] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[346])
   sd_sector_buffer[347] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[347])
   sd_sector_buffer[348] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[348])
   sd_sector_buffer[349] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[349])
   sd_sector_buffer[350] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[350])
   sd_sector_buffer[351] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[351])
   sd_sector_buffer[352] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[352])
   sd_sector_buffer[353] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[353])
   sd_sector_buffer[354] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[354])
   sd_sector_buffer[355] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[355])
   sd_sector_buffer[356] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[356])
   sd_sector_buffer[357] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[357])
   sd_sector_buffer[358] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[358])
   sd_sector_buffer[359] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[359])
   sd_sector_buffer[360] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[360])
   sd_sector_buffer[361] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[361])
   sd_sector_buffer[362] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[362])
   sd_sector_buffer[363] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[363])
   sd_sector_buffer[364] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[364])
   sd_sector_buffer[365] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[365])
   sd_sector_buffer[366] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[366])
   sd_sector_buffer[367] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[367])
   sd_sector_buffer[368] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[368])
   sd_sector_buffer[369] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[369])
   sd_sector_buffer[370] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[370])
   sd_sector_buffer[371] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[371])
   sd_sector_buffer[372] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[372])
   sd_sector_buffer[373] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[373])
   sd_sector_buffer[374] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[374])
   sd_sector_buffer[375] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[375])
   sd_sector_buffer[376] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[376])
   sd_sector_buffer[377] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[377])
   sd_sector_buffer[378] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[378])
   sd_sector_buffer[379] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[379])
   sd_sector_buffer[380] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[380])
   sd_sector_buffer[381] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[381])
   sd_sector_buffer[382] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[382])
   sd_sector_buffer[383] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[383])
   sd_sector_buffer[384] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[384])
   sd_sector_buffer[385] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[385])
   sd_sector_buffer[386] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[386])
   sd_sector_buffer[387] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[387])
   sd_sector_buffer[388] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[388])
   sd_sector_buffer[389] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[389])
   sd_sector_buffer[390] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[390])
   sd_sector_buffer[391] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[391])
   sd_sector_buffer[392] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[392])
   sd_sector_buffer[393] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[393])
   sd_sector_buffer[394] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[394])
   sd_sector_buffer[395] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[395])
   sd_sector_buffer[396] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[396])
   sd_sector_buffer[397] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[397])
   sd_sector_buffer[398] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[398])
   sd_sector_buffer[399] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[399])
   sd_sector_buffer[400] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[400])
   sd_sector_buffer[401] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[401])
   sd_sector_buffer[402] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[402])
   sd_sector_buffer[403] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[403])
   sd_sector_buffer[404] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[404])
   sd_sector_buffer[405] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[405])
   sd_sector_buffer[406] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[406])
   sd_sector_buffer[407] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[407])
   sd_sector_buffer[408] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[408])
   sd_sector_buffer[409] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[409])
   sd_sector_buffer[410] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[410])
   sd_sector_buffer[411] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[411])
   sd_sector_buffer[412] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[412])
   sd_sector_buffer[413] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[413])
   sd_sector_buffer[414] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[414])
   sd_sector_buffer[415] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[415])
   sd_sector_buffer[416] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[416])
   sd_sector_buffer[417] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[417])
   sd_sector_buffer[418] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[418])
   sd_sector_buffer[419] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[419])
   sd_sector_buffer[420] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[420])
   sd_sector_buffer[421] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[421])
   sd_sector_buffer[422] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[422])
   sd_sector_buffer[423] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[423])
   sd_sector_buffer[424] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[424])
   sd_sector_buffer[425] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[425])
   sd_sector_buffer[426] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[426])
   sd_sector_buffer[427] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[427])
   sd_sector_buffer[428] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[428])
   sd_sector_buffer[429] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[429])
   sd_sector_buffer[430] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[430])
   sd_sector_buffer[431] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[431])
   sd_sector_buffer[432] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[432])
   sd_sector_buffer[433] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[433])
   sd_sector_buffer[434] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[434])
   sd_sector_buffer[435] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[435])
   sd_sector_buffer[436] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[436])
   sd_sector_buffer[437] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[437])
   sd_sector_buffer[438] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[438])
   sd_sector_buffer[439] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[439])
   sd_sector_buffer[440] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[440])
   sd_sector_buffer[441] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[441])
   sd_sector_buffer[442] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[442])
   sd_sector_buffer[443] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[443])
   sd_sector_buffer[444] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[444])
   sd_sector_buffer[445] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[445])
   sd_sector_buffer[446] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[446])
   sd_sector_buffer[447] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[447])
   sd_sector_buffer[448] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[448])
   sd_sector_buffer[449] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[449])
   sd_sector_buffer[450] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[450])
   sd_sector_buffer[451] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[451])
   sd_sector_buffer[452] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[452])
   sd_sector_buffer[453] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[453])
   sd_sector_buffer[454] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[454])
   sd_sector_buffer[455] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[455])
   sd_sector_buffer[456] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[456])
   sd_sector_buffer[457] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[457])
   sd_sector_buffer[458] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[458])
   sd_sector_buffer[459] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[459])
   sd_sector_buffer[460] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[460])
   sd_sector_buffer[461] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[461])
   sd_sector_buffer[462] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[462])
   sd_sector_buffer[463] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[463])
   sd_sector_buffer[464] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[464])
   sd_sector_buffer[465] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[465])
   sd_sector_buffer[466] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[466])
   sd_sector_buffer[467] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[467])
   sd_sector_buffer[468] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[468])
   sd_sector_buffer[469] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[469])
   sd_sector_buffer[470] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[470])
   sd_sector_buffer[471] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[471])
   sd_sector_buffer[472] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[472])
   sd_sector_buffer[473] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[473])
   sd_sector_buffer[474] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[474])
   sd_sector_buffer[475] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[475])
   sd_sector_buffer[476] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[476])
   sd_sector_buffer[477] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[477])
   sd_sector_buffer[478] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[478])
   sd_sector_buffer[479] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[479])
   sd_sector_buffer[480] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[480])
   sd_sector_buffer[481] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[481])
   sd_sector_buffer[482] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[482])
   sd_sector_buffer[483] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[483])
   sd_sector_buffer[484] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[484])
   sd_sector_buffer[485] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[485])
   sd_sector_buffer[486] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[486])
   sd_sector_buffer[487] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[487])
   sd_sector_buffer[488] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[488])
   sd_sector_buffer[489] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[489])
   sd_sector_buffer[490] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[490])
   sd_sector_buffer[491] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[491])
   sd_sector_buffer[492] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[492])
   sd_sector_buffer[493] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[493])
   sd_sector_buffer[494] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[494])
   sd_sector_buffer[495] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[495])
   sd_sector_buffer[496] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[496])
   sd_sector_buffer[497] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[497])
   sd_sector_buffer[498] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[498])
   sd_sector_buffer[499] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[499])
   sd_sector_buffer[500] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[500])
   sd_sector_buffer[501] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[501])
   sd_sector_buffer[502] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[502])
   sd_sector_buffer[503] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[503])
   sd_sector_buffer[504] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[504])
   sd_sector_buffer[505] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[505])
   sd_sector_buffer[506] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[506])
   sd_sector_buffer[507] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[507])
   sd_sector_buffer[508] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[508])
   sd_sector_buffer[509] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[509])
   sd_sector_buffer[510] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[510])
   sd_sector_buffer[511] = spi_master
   crc16_calculate_bytes(sd_sector_buffer[511])
end procedure
end if

--------------------------------------------------------------------------------
-- read one entire sector
--------------------------------------------------------------------------------
procedure sd_read_sector() is
   var byte x
   var word count1 = 0

   if sd_read_write_next_ready(SD_READ) == FALSE then return end if -- return on read error

   if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
      -- Optimized CRC calculation: Start incremental CRC16 calculation
      crc16_start(512)
      
      -- get sector data with incremental CRC16 calculation
   if defined(SD_READ_EXTRA_SPEED) == TRUE then
      if SD_READ_EXTRA_SPEED == TRUE then
            -- Use CRC-aware optimized read procedure
            _sd_read_512_crc()
      else
            for 512 using count1 loop
            -- get the data trough spi
               sd_sector_buffer[count1] = spi_master
               crc16_calculate_bytes(sd_sector_buffer[count1])
         end loop
      end if
   else
         for 512 using count1 loop
         -- get the data trough spi
            sd_sector_buffer[count1] = spi_master
            crc16_calculate_bytes(sd_sector_buffer[count1])
      end loop
   end if

      -- Optimized CRC16 verification using incremental calculation
      var word received_crc
      var word calculated_crc
      var byte crc_high
      var byte crc_low
      var bit crc_valid
      
      crc_high = spi_master              -- get CRC16 high byte
      crc_low = spi_master               -- get CRC16 low byte
      received_crc = (word(crc_high) << 8) | word(crc_low)
      
      -- Get the CRC16 result from incremental calculation
      calculated_crc = crc16_get_result()
      
      -- Verify CRC and handle errors
      crc_valid = (calculated_crc == received_crc)
      
      if crc_valid == FALSE then
         -- CRC error detected
         if _crc16_error_occurred_crc == TRUE then
            -- CRC library error
            sd_error_details = sd_error_details | (word(1) << SD_CRC_ERROR)
            sd_has_error = 1
         else
            -- Data CRC mismatch
            sd_error_details = sd_error_details | (word(1) << SD_DATA_CRC_ERROR)
            sd_has_error = 1
         end if
      end if
   else
      -- Original library behavior - get sector data without CRC
      if defined(SD_READ_EXTRA_SPEED) == TRUE then
         if SD_READ_EXTRA_SPEED == TRUE then
            _sd_read_512()
         else
            for 512 using count1 loop
               -- get the data trough spi
               sd_sector_buffer[count1] = spi_master
            end loop
         end if
      else
         for 512 using count1 loop
            -- get the data trough spi
            sd_sector_buffer[count1] = spi_master
         end loop
      end if
      
      -- Original library behavior - just discard CRC bytes
      var byte crc_discard
      crc_discard = spi_master           -- get CRC16 high byte
      crc_discard = spi_master           -- get CRC16 low byte
   end if

   sd_sector_count = sd_sector_count + 1 -- increment sector number
   ;sd_byte_count = sd_byte_count + 2       -- increment byte_count

   sd_sector_select = sd_sector_select + 1
end procedure


;------------------------------------------------------------------------------
; storage_read_callback prototype definition, for use in libs such as USB.
;------------------------------------------------------------------------------
if defined(SD_READ_EXTRA_SPEED) then
   if SD_READ_EXTRA_SPEED == TRUE then
      procedure storage_read_callback(word in chunk_size)
   end if
end if

if defined(SD_WRITE_EXTRA_SPEED) then
   if SD_WRITE_EXTRA_SPEED == TRUE then
      procedure storage_write_callback(word in chunk_size)
   end if
end if

;------------------------------------------------------------------------------
; read one entire sector with callback to storage_read_callback()
; for direct reading with spi_master. Make sure you call spi_master
; chunk_size times in your storage_read_callback().
; chunk_size must be a division of 512 (ex, chunk_size 64 is 512/8)
;------------------------------------------------------------------------------
procedure sd_read_sector_with_callback(word in chunk_size) is
   var byte x
   var byte count1

   if sd_read_write_next_ready(SD_READ) == FALSE then return end if -- return on read error

   sd_byte_count = sd_byte_count + chunk_size

;    get sector data
   if defined(SD_READ_EXTRA_SPEED) == TRUE then
      if SD_READ_EXTRA_SPEED == TRUE then
         storage_read_callback(chunk_size)
      else
         for chunk_size using count1 loop
            -- get the data trough spi
            sd_sector_buffer[count1] = spi_master
         end loop
      end if
   else
      for chunk_size using count1 loop
         -- get the data trough spi
         sd_sector_buffer[count1] = spi_master
      end loop
   end if


   if sd_byte_count == 512 then
      sd_sector_count = sd_sector_count + 1 -- increment sector number
      
      -- Read CRC16 for data block (discard for individual byte reads)
      x = spi_master                     -- get CRC16 high byte
      x = spi_master                     -- get CRC16 low byte

      ;sd_byte_count = sd_byte_count + 2       -- increment byte_count

      sd_sector_select = sd_sector_select + 1
   end if
end procedure



--------------------------------------------------------------------------------
-- read one entire sector at address
--------------------------------------------------------------------------------
procedure sd_read_sector_address(dword in address) is
   sd_start_read(address)
   sd_read_sector()
   sd_stop_read()
end procedure

---------------------------------------------------------------------------
-- Extra speed write procedure
---------------------------------------------------------------------------
procedure _sd_write_512() is
   spi_master = sd_sector_buffer[0]
   spi_master = sd_sector_buffer[1]
   spi_master = sd_sector_buffer[2]
   spi_master = sd_sector_buffer[3]
   spi_master = sd_sector_buffer[4]
   spi_master = sd_sector_buffer[5]
   spi_master = sd_sector_buffer[6]
   spi_master = sd_sector_buffer[7]
   spi_master = sd_sector_buffer[8]
   spi_master = sd_sector_buffer[9]
   spi_master = sd_sector_buffer[10]
   spi_master = sd_sector_buffer[11]
   spi_master = sd_sector_buffer[12]
   spi_master = sd_sector_buffer[13]
   spi_master = sd_sector_buffer[14]
   spi_master = sd_sector_buffer[15]
   spi_master = sd_sector_buffer[16]
   spi_master = sd_sector_buffer[17]
   spi_master = sd_sector_buffer[18]
   spi_master = sd_sector_buffer[19]
   spi_master = sd_sector_buffer[20]
   spi_master = sd_sector_buffer[21]
   spi_master = sd_sector_buffer[22]
   spi_master = sd_sector_buffer[23]
   spi_master = sd_sector_buffer[24]
   spi_master = sd_sector_buffer[25]
   spi_master = sd_sector_buffer[26]
   spi_master = sd_sector_buffer[27]
   spi_master = sd_sector_buffer[28]
   spi_master = sd_sector_buffer[29]
   spi_master = sd_sector_buffer[30]
   spi_master = sd_sector_buffer[31]
   spi_master = sd_sector_buffer[32]
   spi_master = sd_sector_buffer[33]
   spi_master = sd_sector_buffer[34]
   spi_master = sd_sector_buffer[35]
   spi_master = sd_sector_buffer[36]
   spi_master = sd_sector_buffer[37]
   spi_master = sd_sector_buffer[38]
   spi_master = sd_sector_buffer[39]
   spi_master = sd_sector_buffer[40]
   spi_master = sd_sector_buffer[41]
   spi_master = sd_sector_buffer[42]
   spi_master = sd_sector_buffer[43]
   spi_master = sd_sector_buffer[44]
   spi_master = sd_sector_buffer[45]
   spi_master = sd_sector_buffer[46]
   spi_master = sd_sector_buffer[47]
   spi_master = sd_sector_buffer[48]
   spi_master = sd_sector_buffer[49]
   spi_master = sd_sector_buffer[50]
   spi_master = sd_sector_buffer[51]
   spi_master = sd_sector_buffer[52]
   spi_master = sd_sector_buffer[53]
   spi_master = sd_sector_buffer[54]
   spi_master = sd_sector_buffer[55]
   spi_master = sd_sector_buffer[56]
   spi_master = sd_sector_buffer[57]
   spi_master = sd_sector_buffer[58]
   spi_master = sd_sector_buffer[59]
   spi_master = sd_sector_buffer[60]
   spi_master = sd_sector_buffer[61]
   spi_master = sd_sector_buffer[62]
   spi_master = sd_sector_buffer[63]
   spi_master = sd_sector_buffer[64]
   spi_master = sd_sector_buffer[65]
   spi_master = sd_sector_buffer[66]
   spi_master = sd_sector_buffer[67]
   spi_master = sd_sector_buffer[68]
   spi_master = sd_sector_buffer[69]
   spi_master = sd_sector_buffer[70]
   spi_master = sd_sector_buffer[71]
   spi_master = sd_sector_buffer[72]
   spi_master = sd_sector_buffer[73]
   spi_master = sd_sector_buffer[74]
   spi_master = sd_sector_buffer[75]
   spi_master = sd_sector_buffer[76]
   spi_master = sd_sector_buffer[77]
   spi_master = sd_sector_buffer[78]
   spi_master = sd_sector_buffer[79]
   spi_master = sd_sector_buffer[80]
   spi_master = sd_sector_buffer[81]
   spi_master = sd_sector_buffer[82]
   spi_master = sd_sector_buffer[83]
   spi_master = sd_sector_buffer[84]
   spi_master = sd_sector_buffer[85]
   spi_master = sd_sector_buffer[86]
   spi_master = sd_sector_buffer[87]
   spi_master = sd_sector_buffer[88]
   spi_master = sd_sector_buffer[89]
   spi_master = sd_sector_buffer[90]
   spi_master = sd_sector_buffer[91]
   spi_master = sd_sector_buffer[92]
   spi_master = sd_sector_buffer[93]
   spi_master = sd_sector_buffer[94]
   spi_master = sd_sector_buffer[95]
   spi_master = sd_sector_buffer[96]
   spi_master = sd_sector_buffer[97]
   spi_master = sd_sector_buffer[98]
   spi_master = sd_sector_buffer[99]
   spi_master = sd_sector_buffer[100]
   spi_master = sd_sector_buffer[101]
   spi_master = sd_sector_buffer[102]
   spi_master = sd_sector_buffer[103]
   spi_master = sd_sector_buffer[104]
   spi_master = sd_sector_buffer[105]
   spi_master = sd_sector_buffer[106]
   spi_master = sd_sector_buffer[107]
   spi_master = sd_sector_buffer[108]
   spi_master = sd_sector_buffer[109]
   spi_master = sd_sector_buffer[110]
   spi_master = sd_sector_buffer[111]
   spi_master = sd_sector_buffer[112]
   spi_master = sd_sector_buffer[113]
   spi_master = sd_sector_buffer[114]
   spi_master = sd_sector_buffer[115]
   spi_master = sd_sector_buffer[116]
   spi_master = sd_sector_buffer[117]
   spi_master = sd_sector_buffer[118]
   spi_master = sd_sector_buffer[119]
   spi_master = sd_sector_buffer[120]
   spi_master = sd_sector_buffer[121]
   spi_master = sd_sector_buffer[122]
   spi_master = sd_sector_buffer[123]
   spi_master = sd_sector_buffer[124]
   spi_master = sd_sector_buffer[125]
   spi_master = sd_sector_buffer[126]
   spi_master = sd_sector_buffer[127]
   spi_master = sd_sector_buffer[128]
   spi_master = sd_sector_buffer[129]
   spi_master = sd_sector_buffer[130]
   spi_master = sd_sector_buffer[131]
   spi_master = sd_sector_buffer[132]
   spi_master = sd_sector_buffer[133]
   spi_master = sd_sector_buffer[134]
   spi_master = sd_sector_buffer[135]
   spi_master = sd_sector_buffer[136]
   spi_master = sd_sector_buffer[137]
   spi_master = sd_sector_buffer[138]
   spi_master = sd_sector_buffer[139]
   spi_master = sd_sector_buffer[140]
   spi_master = sd_sector_buffer[141]
   spi_master = sd_sector_buffer[142]
   spi_master = sd_sector_buffer[143]
   spi_master = sd_sector_buffer[144]
   spi_master = sd_sector_buffer[145]
   spi_master = sd_sector_buffer[146]
   spi_master = sd_sector_buffer[147]
   spi_master = sd_sector_buffer[148]
   spi_master = sd_sector_buffer[149]
   spi_master = sd_sector_buffer[150]
   spi_master = sd_sector_buffer[151]
   spi_master = sd_sector_buffer[152]
   spi_master = sd_sector_buffer[153]
   spi_master = sd_sector_buffer[154]
   spi_master = sd_sector_buffer[155]
   spi_master = sd_sector_buffer[156]
   spi_master = sd_sector_buffer[157]
   spi_master = sd_sector_buffer[158]
   spi_master = sd_sector_buffer[159]
   spi_master = sd_sector_buffer[160]
   spi_master = sd_sector_buffer[161]
   spi_master = sd_sector_buffer[162]
   spi_master = sd_sector_buffer[163]
   spi_master = sd_sector_buffer[164]
   spi_master = sd_sector_buffer[165]
   spi_master = sd_sector_buffer[166]
   spi_master = sd_sector_buffer[167]
   spi_master = sd_sector_buffer[168]
   spi_master = sd_sector_buffer[169]
   spi_master = sd_sector_buffer[170]
   spi_master = sd_sector_buffer[171]
   spi_master = sd_sector_buffer[172]
   spi_master = sd_sector_buffer[173]
   spi_master = sd_sector_buffer[174]
   spi_master = sd_sector_buffer[175]
   spi_master = sd_sector_buffer[176]
   spi_master = sd_sector_buffer[177]
   spi_master = sd_sector_buffer[178]
   spi_master = sd_sector_buffer[179]
   spi_master = sd_sector_buffer[180]
   spi_master = sd_sector_buffer[181]
   spi_master = sd_sector_buffer[182]
   spi_master = sd_sector_buffer[183]
   spi_master = sd_sector_buffer[184]
   spi_master = sd_sector_buffer[185]
   spi_master = sd_sector_buffer[186]
   spi_master = sd_sector_buffer[187]
   spi_master = sd_sector_buffer[188]
   spi_master = sd_sector_buffer[189]
   spi_master = sd_sector_buffer[190]
   spi_master = sd_sector_buffer[191]
   spi_master = sd_sector_buffer[192]
   spi_master = sd_sector_buffer[193]
   spi_master = sd_sector_buffer[194]
   spi_master = sd_sector_buffer[195]
   spi_master = sd_sector_buffer[196]
   spi_master = sd_sector_buffer[197]
   spi_master = sd_sector_buffer[198]
   spi_master = sd_sector_buffer[199]
   spi_master = sd_sector_buffer[200]
   spi_master = sd_sector_buffer[201]
   spi_master = sd_sector_buffer[202]
   spi_master = sd_sector_buffer[203]
   spi_master = sd_sector_buffer[204]
   spi_master = sd_sector_buffer[205]
   spi_master = sd_sector_buffer[206]
   spi_master = sd_sector_buffer[207]
   spi_master = sd_sector_buffer[208]
   spi_master = sd_sector_buffer[209]
   spi_master = sd_sector_buffer[210]
   spi_master = sd_sector_buffer[211]
   spi_master = sd_sector_buffer[212]
   spi_master = sd_sector_buffer[213]
   spi_master = sd_sector_buffer[214]
   spi_master = sd_sector_buffer[215]
   spi_master = sd_sector_buffer[216]
   spi_master = sd_sector_buffer[217]
   spi_master = sd_sector_buffer[218]
   spi_master = sd_sector_buffer[219]
   spi_master = sd_sector_buffer[220]
   spi_master = sd_sector_buffer[221]
   spi_master = sd_sector_buffer[222]
   spi_master = sd_sector_buffer[223]
   spi_master = sd_sector_buffer[224]
   spi_master = sd_sector_buffer[225]
   spi_master = sd_sector_buffer[226]
   spi_master = sd_sector_buffer[227]
   spi_master = sd_sector_buffer[228]
   spi_master = sd_sector_buffer[229]
   spi_master = sd_sector_buffer[230]
   spi_master = sd_sector_buffer[231]
   spi_master = sd_sector_buffer[232]
   spi_master = sd_sector_buffer[233]
   spi_master = sd_sector_buffer[234]
   spi_master = sd_sector_buffer[235]
   spi_master = sd_sector_buffer[236]
   spi_master = sd_sector_buffer[237]
   spi_master = sd_sector_buffer[238]
   spi_master = sd_sector_buffer[239]
   spi_master = sd_sector_buffer[240]
   spi_master = sd_sector_buffer[241]
   spi_master = sd_sector_buffer[242]
   spi_master = sd_sector_buffer[243]
   spi_master = sd_sector_buffer[244]
   spi_master = sd_sector_buffer[245]
   spi_master = sd_sector_buffer[246]
   spi_master = sd_sector_buffer[247]
   spi_master = sd_sector_buffer[248]
   spi_master = sd_sector_buffer[249]
   spi_master = sd_sector_buffer[250]
   spi_master = sd_sector_buffer[251]
   spi_master = sd_sector_buffer[252]
   spi_master = sd_sector_buffer[253]
   spi_master = sd_sector_buffer[254]
   spi_master = sd_sector_buffer[255]
   spi_master = sd_sector_buffer[256]
   spi_master = sd_sector_buffer[257]
   spi_master = sd_sector_buffer[258]
   spi_master = sd_sector_buffer[259]
   spi_master = sd_sector_buffer[260]
   spi_master = sd_sector_buffer[261]
   spi_master = sd_sector_buffer[262]
   spi_master = sd_sector_buffer[263]
   spi_master = sd_sector_buffer[264]
   spi_master = sd_sector_buffer[265]
   spi_master = sd_sector_buffer[266]
   spi_master = sd_sector_buffer[267]
   spi_master = sd_sector_buffer[268]
   spi_master = sd_sector_buffer[269]
   spi_master = sd_sector_buffer[270]
   spi_master = sd_sector_buffer[271]
   spi_master = sd_sector_buffer[272]
   spi_master = sd_sector_buffer[273]
   spi_master = sd_sector_buffer[274]
   spi_master = sd_sector_buffer[275]
   spi_master = sd_sector_buffer[276]
   spi_master = sd_sector_buffer[277]
   spi_master = sd_sector_buffer[278]
   spi_master = sd_sector_buffer[279]
   spi_master = sd_sector_buffer[280]
   spi_master = sd_sector_buffer[281]
   spi_master = sd_sector_buffer[282]
   spi_master = sd_sector_buffer[283]
   spi_master = sd_sector_buffer[284]
   spi_master = sd_sector_buffer[285]
   spi_master = sd_sector_buffer[286]
   spi_master = sd_sector_buffer[287]
   spi_master = sd_sector_buffer[288]
   spi_master = sd_sector_buffer[289]
   spi_master = sd_sector_buffer[290]
   spi_master = sd_sector_buffer[291]
   spi_master = sd_sector_buffer[292]
   spi_master = sd_sector_buffer[293]
   spi_master = sd_sector_buffer[294]
   spi_master = sd_sector_buffer[295]
   spi_master = sd_sector_buffer[296]
   spi_master = sd_sector_buffer[297]
   spi_master = sd_sector_buffer[298]
   spi_master = sd_sector_buffer[299]
   spi_master = sd_sector_buffer[300]
   spi_master = sd_sector_buffer[301]
   spi_master = sd_sector_buffer[302]
   spi_master = sd_sector_buffer[303]
   spi_master = sd_sector_buffer[304]
   spi_master = sd_sector_buffer[305]
   spi_master = sd_sector_buffer[306]
   spi_master = sd_sector_buffer[307]
   spi_master = sd_sector_buffer[308]
   spi_master = sd_sector_buffer[309]
   spi_master = sd_sector_buffer[310]
   spi_master = sd_sector_buffer[311]
   spi_master = sd_sector_buffer[312]
   spi_master = sd_sector_buffer[313]
   spi_master = sd_sector_buffer[314]
   spi_master = sd_sector_buffer[315]
   spi_master = sd_sector_buffer[316]
   spi_master = sd_sector_buffer[317]
   spi_master = sd_sector_buffer[318]
   spi_master = sd_sector_buffer[319]
   spi_master = sd_sector_buffer[320]
   spi_master = sd_sector_buffer[321]
   spi_master = sd_sector_buffer[322]
   spi_master = sd_sector_buffer[323]
   spi_master = sd_sector_buffer[324]
   spi_master = sd_sector_buffer[325]
   spi_master = sd_sector_buffer[326]
   spi_master = sd_sector_buffer[327]
   spi_master = sd_sector_buffer[328]
   spi_master = sd_sector_buffer[329]
   spi_master = sd_sector_buffer[330]
   spi_master = sd_sector_buffer[331]
   spi_master = sd_sector_buffer[332]
   spi_master = sd_sector_buffer[333]
   spi_master = sd_sector_buffer[334]
   spi_master = sd_sector_buffer[335]
   spi_master = sd_sector_buffer[336]
   spi_master = sd_sector_buffer[337]
   spi_master = sd_sector_buffer[338]
   spi_master = sd_sector_buffer[339]
   spi_master = sd_sector_buffer[340]
   spi_master = sd_sector_buffer[341]
   spi_master = sd_sector_buffer[342]
   spi_master = sd_sector_buffer[343]
   spi_master = sd_sector_buffer[344]
   spi_master = sd_sector_buffer[345]
   spi_master = sd_sector_buffer[346]
   spi_master = sd_sector_buffer[347]
   spi_master = sd_sector_buffer[348]
   spi_master = sd_sector_buffer[349]
   spi_master = sd_sector_buffer[350]
   spi_master = sd_sector_buffer[351]
   spi_master = sd_sector_buffer[352]
   spi_master = sd_sector_buffer[353]
   spi_master = sd_sector_buffer[354]
   spi_master = sd_sector_buffer[355]
   spi_master = sd_sector_buffer[356]
   spi_master = sd_sector_buffer[357]
   spi_master = sd_sector_buffer[358]
   spi_master = sd_sector_buffer[359]
   spi_master = sd_sector_buffer[360]
   spi_master = sd_sector_buffer[361]
   spi_master = sd_sector_buffer[362]
   spi_master = sd_sector_buffer[363]
   spi_master = sd_sector_buffer[364]
   spi_master = sd_sector_buffer[365]
   spi_master = sd_sector_buffer[366]
   spi_master = sd_sector_buffer[367]
   spi_master = sd_sector_buffer[368]
   spi_master = sd_sector_buffer[369]
   spi_master = sd_sector_buffer[370]
   spi_master = sd_sector_buffer[371]
   spi_master = sd_sector_buffer[372]
   spi_master = sd_sector_buffer[373]
   spi_master = sd_sector_buffer[374]
   spi_master = sd_sector_buffer[375]
   spi_master = sd_sector_buffer[376]
   spi_master = sd_sector_buffer[377]
   spi_master = sd_sector_buffer[378]
   spi_master = sd_sector_buffer[379]
   spi_master = sd_sector_buffer[380]
   spi_master = sd_sector_buffer[381]
   spi_master = sd_sector_buffer[382]
   spi_master = sd_sector_buffer[383]
   spi_master = sd_sector_buffer[384]
   spi_master = sd_sector_buffer[385]
   spi_master = sd_sector_buffer[386]
   spi_master = sd_sector_buffer[387]
   spi_master = sd_sector_buffer[388]
   spi_master = sd_sector_buffer[389]
   spi_master = sd_sector_buffer[390]
   spi_master = sd_sector_buffer[391]
   spi_master = sd_sector_buffer[392]
   spi_master = sd_sector_buffer[393]
   spi_master = sd_sector_buffer[394]
   spi_master = sd_sector_buffer[395]
   spi_master = sd_sector_buffer[396]
   spi_master = sd_sector_buffer[397]
   spi_master = sd_sector_buffer[398]
   spi_master = sd_sector_buffer[399]
   spi_master = sd_sector_buffer[400]
   spi_master = sd_sector_buffer[401]
   spi_master = sd_sector_buffer[402]
   spi_master = sd_sector_buffer[403]
   spi_master = sd_sector_buffer[404]
   spi_master = sd_sector_buffer[405]
   spi_master = sd_sector_buffer[406]
   spi_master = sd_sector_buffer[407]
   spi_master = sd_sector_buffer[408]
   spi_master = sd_sector_buffer[409]
   spi_master = sd_sector_buffer[410]
   spi_master = sd_sector_buffer[411]
   spi_master = sd_sector_buffer[412]
   spi_master = sd_sector_buffer[413]
   spi_master = sd_sector_buffer[414]
   spi_master = sd_sector_buffer[415]
   spi_master = sd_sector_buffer[416]
   spi_master = sd_sector_buffer[417]
   spi_master = sd_sector_buffer[418]
   spi_master = sd_sector_buffer[419]
   spi_master = sd_sector_buffer[420]
   spi_master = sd_sector_buffer[421]
   spi_master = sd_sector_buffer[422]
   spi_master = sd_sector_buffer[423]
   spi_master = sd_sector_buffer[424]
   spi_master = sd_sector_buffer[425]
   spi_master = sd_sector_buffer[426]
   spi_master = sd_sector_buffer[427]
   spi_master = sd_sector_buffer[428]
   spi_master = sd_sector_buffer[429]
   spi_master = sd_sector_buffer[430]
   spi_master = sd_sector_buffer[431]
   spi_master = sd_sector_buffer[432]
   spi_master = sd_sector_buffer[433]
   spi_master = sd_sector_buffer[434]
   spi_master = sd_sector_buffer[435]
   spi_master = sd_sector_buffer[436]
   spi_master = sd_sector_buffer[437]
   spi_master = sd_sector_buffer[438]
   spi_master = sd_sector_buffer[439]
   spi_master = sd_sector_buffer[440]
   spi_master = sd_sector_buffer[441]
   spi_master = sd_sector_buffer[442]
   spi_master = sd_sector_buffer[443]
   spi_master = sd_sector_buffer[444]
   spi_master = sd_sector_buffer[445]
   spi_master = sd_sector_buffer[446]
   spi_master = sd_sector_buffer[447]
   spi_master = sd_sector_buffer[448]
   spi_master = sd_sector_buffer[449]
   spi_master = sd_sector_buffer[450]
   spi_master = sd_sector_buffer[451]
   spi_master = sd_sector_buffer[452]
   spi_master = sd_sector_buffer[453]
   spi_master = sd_sector_buffer[454]
   spi_master = sd_sector_buffer[455]
   spi_master = sd_sector_buffer[456]
   spi_master = sd_sector_buffer[457]
   spi_master = sd_sector_buffer[458]
   spi_master = sd_sector_buffer[459]
   spi_master = sd_sector_buffer[460]
   spi_master = sd_sector_buffer[461]
   spi_master = sd_sector_buffer[462]
   spi_master = sd_sector_buffer[463]
   spi_master = sd_sector_buffer[464]
   spi_master = sd_sector_buffer[465]
   spi_master = sd_sector_buffer[466]
   spi_master = sd_sector_buffer[467]
   spi_master = sd_sector_buffer[468]
   spi_master = sd_sector_buffer[469]
   spi_master = sd_sector_buffer[470]
   spi_master = sd_sector_buffer[471]
   spi_master = sd_sector_buffer[472]
   spi_master = sd_sector_buffer[473]
   spi_master = sd_sector_buffer[474]
   spi_master = sd_sector_buffer[475]
   spi_master = sd_sector_buffer[476]
   spi_master = sd_sector_buffer[477]
   spi_master = sd_sector_buffer[478]
   spi_master = sd_sector_buffer[479]
   spi_master = sd_sector_buffer[480]
   spi_master = sd_sector_buffer[481]
   spi_master = sd_sector_buffer[482]
   spi_master = sd_sector_buffer[483]
   spi_master = sd_sector_buffer[484]
   spi_master = sd_sector_buffer[485]
   spi_master = sd_sector_buffer[486]
   spi_master = sd_sector_buffer[487]
   spi_master = sd_sector_buffer[488]
   spi_master = sd_sector_buffer[489]
   spi_master = sd_sector_buffer[490]
   spi_master = sd_sector_buffer[491]
   spi_master = sd_sector_buffer[492]
   spi_master = sd_sector_buffer[493]
   spi_master = sd_sector_buffer[494]
   spi_master = sd_sector_buffer[495]
   spi_master = sd_sector_buffer[496]
   spi_master = sd_sector_buffer[497]
   spi_master = sd_sector_buffer[498]
   spi_master = sd_sector_buffer[499]
   spi_master = sd_sector_buffer[500]
   spi_master = sd_sector_buffer[501]
   spi_master = sd_sector_buffer[502]
   spi_master = sd_sector_buffer[503]
   spi_master = sd_sector_buffer[504]
   spi_master = sd_sector_buffer[505]
   spi_master = sd_sector_buffer[506]
   spi_master = sd_sector_buffer[507]
   spi_master = sd_sector_buffer[508]
   spi_master = sd_sector_buffer[509]
   spi_master = sd_sector_buffer[510]
   spi_master = sd_sector_buffer[511]
end procedure

--------------------------------------------------------------------------------
-- Extra speed write procedure with CRC calculation
--------------------------------------------------------------------------------
--------------------------------------------------------------------------------
-- Extra speed write procedure with CRC calculation
--------------------------------------------------------------------------------
if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
procedure _sd_write_512_crc() is
   spi_master = sd_sector_buffer[0]
   crc16_calculate_bytes(sd_sector_buffer[0])
   spi_master = sd_sector_buffer[1]
   crc16_calculate_bytes(sd_sector_buffer[1])
   spi_master = sd_sector_buffer[2]
   crc16_calculate_bytes(sd_sector_buffer[2])
   spi_master = sd_sector_buffer[3]
   crc16_calculate_bytes(sd_sector_buffer[3])
   spi_master = sd_sector_buffer[4]
   crc16_calculate_bytes(sd_sector_buffer[4])
   spi_master = sd_sector_buffer[5]
   crc16_calculate_bytes(sd_sector_buffer[5])
   spi_master = sd_sector_buffer[6]
   crc16_calculate_bytes(sd_sector_buffer[6])
   spi_master = sd_sector_buffer[7]
   crc16_calculate_bytes(sd_sector_buffer[7])
   spi_master = sd_sector_buffer[8]
   crc16_calculate_bytes(sd_sector_buffer[8])
   spi_master = sd_sector_buffer[9]
   crc16_calculate_bytes(sd_sector_buffer[9])
   spi_master = sd_sector_buffer[10]
   crc16_calculate_bytes(sd_sector_buffer[10])
   spi_master = sd_sector_buffer[11]
   crc16_calculate_bytes(sd_sector_buffer[11])
   spi_master = sd_sector_buffer[12]
   crc16_calculate_bytes(sd_sector_buffer[12])
   spi_master = sd_sector_buffer[13]
   crc16_calculate_bytes(sd_sector_buffer[13])
   spi_master = sd_sector_buffer[14]
   crc16_calculate_bytes(sd_sector_buffer[14])
   spi_master = sd_sector_buffer[15]
   crc16_calculate_bytes(sd_sector_buffer[15])
   spi_master = sd_sector_buffer[16]
   crc16_calculate_bytes(sd_sector_buffer[16])
   spi_master = sd_sector_buffer[17]
   crc16_calculate_bytes(sd_sector_buffer[17])
   spi_master = sd_sector_buffer[18]
   crc16_calculate_bytes(sd_sector_buffer[18])
   spi_master = sd_sector_buffer[19]
   crc16_calculate_bytes(sd_sector_buffer[19])
   spi_master = sd_sector_buffer[20]
   crc16_calculate_bytes(sd_sector_buffer[20])
   spi_master = sd_sector_buffer[21]
   crc16_calculate_bytes(sd_sector_buffer[21])
   spi_master = sd_sector_buffer[22]
   crc16_calculate_bytes(sd_sector_buffer[22])
   spi_master = sd_sector_buffer[23]
   crc16_calculate_bytes(sd_sector_buffer[23])
   spi_master = sd_sector_buffer[24]
   crc16_calculate_bytes(sd_sector_buffer[24])
   spi_master = sd_sector_buffer[25]
   crc16_calculate_bytes(sd_sector_buffer[25])
   spi_master = sd_sector_buffer[26]
   crc16_calculate_bytes(sd_sector_buffer[26])
   spi_master = sd_sector_buffer[27]
   crc16_calculate_bytes(sd_sector_buffer[27])
   spi_master = sd_sector_buffer[28]
   crc16_calculate_bytes(sd_sector_buffer[28])
   spi_master = sd_sector_buffer[29]
   crc16_calculate_bytes(sd_sector_buffer[29])
   spi_master = sd_sector_buffer[30]
   crc16_calculate_bytes(sd_sector_buffer[30])
   spi_master = sd_sector_buffer[31]
   crc16_calculate_bytes(sd_sector_buffer[31])
   spi_master = sd_sector_buffer[32]
   crc16_calculate_bytes(sd_sector_buffer[32])
   spi_master = sd_sector_buffer[33]
   crc16_calculate_bytes(sd_sector_buffer[33])
   spi_master = sd_sector_buffer[34]
   crc16_calculate_bytes(sd_sector_buffer[34])
   spi_master = sd_sector_buffer[35]
   crc16_calculate_bytes(sd_sector_buffer[35])
   spi_master = sd_sector_buffer[36]
   crc16_calculate_bytes(sd_sector_buffer[36])
   spi_master = sd_sector_buffer[37]
   crc16_calculate_bytes(sd_sector_buffer[37])
   spi_master = sd_sector_buffer[38]
   crc16_calculate_bytes(sd_sector_buffer[38])
   spi_master = sd_sector_buffer[39]
   crc16_calculate_bytes(sd_sector_buffer[39])
   spi_master = sd_sector_buffer[40]
   crc16_calculate_bytes(sd_sector_buffer[40])
   spi_master = sd_sector_buffer[41]
   crc16_calculate_bytes(sd_sector_buffer[41])
   spi_master = sd_sector_buffer[42]
   crc16_calculate_bytes(sd_sector_buffer[42])
   spi_master = sd_sector_buffer[43]
   crc16_calculate_bytes(sd_sector_buffer[43])
   spi_master = sd_sector_buffer[44]
   crc16_calculate_bytes(sd_sector_buffer[44])
   spi_master = sd_sector_buffer[45]
   crc16_calculate_bytes(sd_sector_buffer[45])
   spi_master = sd_sector_buffer[46]
   crc16_calculate_bytes(sd_sector_buffer[46])
   spi_master = sd_sector_buffer[47]
   crc16_calculate_bytes(sd_sector_buffer[47])
   spi_master = sd_sector_buffer[48]
   crc16_calculate_bytes(sd_sector_buffer[48])
   spi_master = sd_sector_buffer[49]
   crc16_calculate_bytes(sd_sector_buffer[49])
   spi_master = sd_sector_buffer[50]
   crc16_calculate_bytes(sd_sector_buffer[50])
   spi_master = sd_sector_buffer[51]
   crc16_calculate_bytes(sd_sector_buffer[51])
   spi_master = sd_sector_buffer[52]
   crc16_calculate_bytes(sd_sector_buffer[52])
   spi_master = sd_sector_buffer[53]
   crc16_calculate_bytes(sd_sector_buffer[53])
   spi_master = sd_sector_buffer[54]
   crc16_calculate_bytes(sd_sector_buffer[54])
   spi_master = sd_sector_buffer[55]
   crc16_calculate_bytes(sd_sector_buffer[55])
   spi_master = sd_sector_buffer[56]
   crc16_calculate_bytes(sd_sector_buffer[56])
   spi_master = sd_sector_buffer[57]
   crc16_calculate_bytes(sd_sector_buffer[57])
   spi_master = sd_sector_buffer[58]
   crc16_calculate_bytes(sd_sector_buffer[58])
   spi_master = sd_sector_buffer[59]
   crc16_calculate_bytes(sd_sector_buffer[59])
   spi_master = sd_sector_buffer[60]
   crc16_calculate_bytes(sd_sector_buffer[60])
   spi_master = sd_sector_buffer[61]
   crc16_calculate_bytes(sd_sector_buffer[61])
   spi_master = sd_sector_buffer[62]
   crc16_calculate_bytes(sd_sector_buffer[62])
   spi_master = sd_sector_buffer[63]
   crc16_calculate_bytes(sd_sector_buffer[63])
   spi_master = sd_sector_buffer[64]
   crc16_calculate_bytes(sd_sector_buffer[64])
   spi_master = sd_sector_buffer[65]
   crc16_calculate_bytes(sd_sector_buffer[65])
   spi_master = sd_sector_buffer[66]
   crc16_calculate_bytes(sd_sector_buffer[66])
   spi_master = sd_sector_buffer[67]
   crc16_calculate_bytes(sd_sector_buffer[67])
   spi_master = sd_sector_buffer[68]
   crc16_calculate_bytes(sd_sector_buffer[68])
   spi_master = sd_sector_buffer[69]
   crc16_calculate_bytes(sd_sector_buffer[69])
   spi_master = sd_sector_buffer[70]
   crc16_calculate_bytes(sd_sector_buffer[70])
   spi_master = sd_sector_buffer[71]
   crc16_calculate_bytes(sd_sector_buffer[71])
   spi_master = sd_sector_buffer[72]
   crc16_calculate_bytes(sd_sector_buffer[72])
   spi_master = sd_sector_buffer[73]
   crc16_calculate_bytes(sd_sector_buffer[73])
   spi_master = sd_sector_buffer[74]
   crc16_calculate_bytes(sd_sector_buffer[74])
   spi_master = sd_sector_buffer[75]
   crc16_calculate_bytes(sd_sector_buffer[75])
   spi_master = sd_sector_buffer[76]
   crc16_calculate_bytes(sd_sector_buffer[76])
   spi_master = sd_sector_buffer[77]
   crc16_calculate_bytes(sd_sector_buffer[77])
   spi_master = sd_sector_buffer[78]
   crc16_calculate_bytes(sd_sector_buffer[78])
   spi_master = sd_sector_buffer[79]
   crc16_calculate_bytes(sd_sector_buffer[79])
   spi_master = sd_sector_buffer[80]
   crc16_calculate_bytes(sd_sector_buffer[80])
   spi_master = sd_sector_buffer[81]
   crc16_calculate_bytes(sd_sector_buffer[81])
   spi_master = sd_sector_buffer[82]
   crc16_calculate_bytes(sd_sector_buffer[82])
   spi_master = sd_sector_buffer[83]
   crc16_calculate_bytes(sd_sector_buffer[83])
   spi_master = sd_sector_buffer[84]
   crc16_calculate_bytes(sd_sector_buffer[84])
   spi_master = sd_sector_buffer[85]
   crc16_calculate_bytes(sd_sector_buffer[85])
   spi_master = sd_sector_buffer[86]
   crc16_calculate_bytes(sd_sector_buffer[86])
   spi_master = sd_sector_buffer[87]
   crc16_calculate_bytes(sd_sector_buffer[87])
   spi_master = sd_sector_buffer[88]
   crc16_calculate_bytes(sd_sector_buffer[88])
   spi_master = sd_sector_buffer[89]
   crc16_calculate_bytes(sd_sector_buffer[89])
   spi_master = sd_sector_buffer[90]
   crc16_calculate_bytes(sd_sector_buffer[90])
   spi_master = sd_sector_buffer[91]
   crc16_calculate_bytes(sd_sector_buffer[91])
   spi_master = sd_sector_buffer[92]
   crc16_calculate_bytes(sd_sector_buffer[92])
   spi_master = sd_sector_buffer[93]
   crc16_calculate_bytes(sd_sector_buffer[93])
   spi_master = sd_sector_buffer[94]
   crc16_calculate_bytes(sd_sector_buffer[94])
   spi_master = sd_sector_buffer[95]
   crc16_calculate_bytes(sd_sector_buffer[95])
   spi_master = sd_sector_buffer[96]
   crc16_calculate_bytes(sd_sector_buffer[96])
   spi_master = sd_sector_buffer[97]
   crc16_calculate_bytes(sd_sector_buffer[97])
   spi_master = sd_sector_buffer[98]
   crc16_calculate_bytes(sd_sector_buffer[98])
   spi_master = sd_sector_buffer[99]
   crc16_calculate_bytes(sd_sector_buffer[99])
   spi_master = sd_sector_buffer[100]
   crc16_calculate_bytes(sd_sector_buffer[100])
   spi_master = sd_sector_buffer[101]
   crc16_calculate_bytes(sd_sector_buffer[101])
   spi_master = sd_sector_buffer[102]
   crc16_calculate_bytes(sd_sector_buffer[102])
   spi_master = sd_sector_buffer[103]
   crc16_calculate_bytes(sd_sector_buffer[103])
   spi_master = sd_sector_buffer[104]
   crc16_calculate_bytes(sd_sector_buffer[104])
   spi_master = sd_sector_buffer[105]
   crc16_calculate_bytes(sd_sector_buffer[105])
   spi_master = sd_sector_buffer[106]
   crc16_calculate_bytes(sd_sector_buffer[106])
   spi_master = sd_sector_buffer[107]
   crc16_calculate_bytes(sd_sector_buffer[107])
   spi_master = sd_sector_buffer[108]
   crc16_calculate_bytes(sd_sector_buffer[108])
   spi_master = sd_sector_buffer[109]
   crc16_calculate_bytes(sd_sector_buffer[109])
   spi_master = sd_sector_buffer[110]
   crc16_calculate_bytes(sd_sector_buffer[110])
   spi_master = sd_sector_buffer[111]
   crc16_calculate_bytes(sd_sector_buffer[111])
   spi_master = sd_sector_buffer[112]
   crc16_calculate_bytes(sd_sector_buffer[112])
   spi_master = sd_sector_buffer[113]
   crc16_calculate_bytes(sd_sector_buffer[113])
   spi_master = sd_sector_buffer[114]
   crc16_calculate_bytes(sd_sector_buffer[114])
   spi_master = sd_sector_buffer[115]
   crc16_calculate_bytes(sd_sector_buffer[115])
   spi_master = sd_sector_buffer[116]
   crc16_calculate_bytes(sd_sector_buffer[116])
   spi_master = sd_sector_buffer[117]
   crc16_calculate_bytes(sd_sector_buffer[117])
   spi_master = sd_sector_buffer[118]
   crc16_calculate_bytes(sd_sector_buffer[118])
   spi_master = sd_sector_buffer[119]
   crc16_calculate_bytes(sd_sector_buffer[119])
   spi_master = sd_sector_buffer[120]
   crc16_calculate_bytes(sd_sector_buffer[120])
   spi_master = sd_sector_buffer[121]
   crc16_calculate_bytes(sd_sector_buffer[121])
   spi_master = sd_sector_buffer[122]
   crc16_calculate_bytes(sd_sector_buffer[122])
   spi_master = sd_sector_buffer[123]
   crc16_calculate_bytes(sd_sector_buffer[123])
   spi_master = sd_sector_buffer[124]
   crc16_calculate_bytes(sd_sector_buffer[124])
   spi_master = sd_sector_buffer[125]
   crc16_calculate_bytes(sd_sector_buffer[125])
   spi_master = sd_sector_buffer[126]
   crc16_calculate_bytes(sd_sector_buffer[126])
   spi_master = sd_sector_buffer[127]
   crc16_calculate_bytes(sd_sector_buffer[127])
   spi_master = sd_sector_buffer[128]
   crc16_calculate_bytes(sd_sector_buffer[128])
   spi_master = sd_sector_buffer[129]
   crc16_calculate_bytes(sd_sector_buffer[129])
   spi_master = sd_sector_buffer[130]
   crc16_calculate_bytes(sd_sector_buffer[130])
   spi_master = sd_sector_buffer[131]
   crc16_calculate_bytes(sd_sector_buffer[131])
   spi_master = sd_sector_buffer[132]
   crc16_calculate_bytes(sd_sector_buffer[132])
   spi_master = sd_sector_buffer[133]
   crc16_calculate_bytes(sd_sector_buffer[133])
   spi_master = sd_sector_buffer[134]
   crc16_calculate_bytes(sd_sector_buffer[134])
   spi_master = sd_sector_buffer[135]
   crc16_calculate_bytes(sd_sector_buffer[135])
   spi_master = sd_sector_buffer[136]
   crc16_calculate_bytes(sd_sector_buffer[136])
   spi_master = sd_sector_buffer[137]
   crc16_calculate_bytes(sd_sector_buffer[137])
   spi_master = sd_sector_buffer[138]
   crc16_calculate_bytes(sd_sector_buffer[138])
   spi_master = sd_sector_buffer[139]
   crc16_calculate_bytes(sd_sector_buffer[139])
   spi_master = sd_sector_buffer[140]
   crc16_calculate_bytes(sd_sector_buffer[140])
   spi_master = sd_sector_buffer[141]
   crc16_calculate_bytes(sd_sector_buffer[141])
   spi_master = sd_sector_buffer[142]
   crc16_calculate_bytes(sd_sector_buffer[142])
   spi_master = sd_sector_buffer[143]
   crc16_calculate_bytes(sd_sector_buffer[143])
   spi_master = sd_sector_buffer[144]
   crc16_calculate_bytes(sd_sector_buffer[144])
   spi_master = sd_sector_buffer[145]
   crc16_calculate_bytes(sd_sector_buffer[145])
   spi_master = sd_sector_buffer[146]
   crc16_calculate_bytes(sd_sector_buffer[146])
   spi_master = sd_sector_buffer[147]
   crc16_calculate_bytes(sd_sector_buffer[147])
   spi_master = sd_sector_buffer[148]
   crc16_calculate_bytes(sd_sector_buffer[148])
   spi_master = sd_sector_buffer[149]
   crc16_calculate_bytes(sd_sector_buffer[149])
   spi_master = sd_sector_buffer[150]
   crc16_calculate_bytes(sd_sector_buffer[150])
   spi_master = sd_sector_buffer[151]
   crc16_calculate_bytes(sd_sector_buffer[151])
   spi_master = sd_sector_buffer[152]
   crc16_calculate_bytes(sd_sector_buffer[152])
   spi_master = sd_sector_buffer[153]
   crc16_calculate_bytes(sd_sector_buffer[153])
   spi_master = sd_sector_buffer[154]
   crc16_calculate_bytes(sd_sector_buffer[154])
   spi_master = sd_sector_buffer[155]
   crc16_calculate_bytes(sd_sector_buffer[155])
   spi_master = sd_sector_buffer[156]
   crc16_calculate_bytes(sd_sector_buffer[156])
   spi_master = sd_sector_buffer[157]
   crc16_calculate_bytes(sd_sector_buffer[157])
   spi_master = sd_sector_buffer[158]
   crc16_calculate_bytes(sd_sector_buffer[158])
   spi_master = sd_sector_buffer[159]
   crc16_calculate_bytes(sd_sector_buffer[159])
   spi_master = sd_sector_buffer[160]
   crc16_calculate_bytes(sd_sector_buffer[160])
   spi_master = sd_sector_buffer[161]
   crc16_calculate_bytes(sd_sector_buffer[161])
   spi_master = sd_sector_buffer[162]
   crc16_calculate_bytes(sd_sector_buffer[162])
   spi_master = sd_sector_buffer[163]
   crc16_calculate_bytes(sd_sector_buffer[163])
   spi_master = sd_sector_buffer[164]
   crc16_calculate_bytes(sd_sector_buffer[164])
   spi_master = sd_sector_buffer[165]
   crc16_calculate_bytes(sd_sector_buffer[165])
   spi_master = sd_sector_buffer[166]
   crc16_calculate_bytes(sd_sector_buffer[166])
   spi_master = sd_sector_buffer[167]
   crc16_calculate_bytes(sd_sector_buffer[167])
   spi_master = sd_sector_buffer[168]
   crc16_calculate_bytes(sd_sector_buffer[168])
   spi_master = sd_sector_buffer[169]
   crc16_calculate_bytes(sd_sector_buffer[169])
   spi_master = sd_sector_buffer[170]
   crc16_calculate_bytes(sd_sector_buffer[170])
   spi_master = sd_sector_buffer[171]
   crc16_calculate_bytes(sd_sector_buffer[171])
   spi_master = sd_sector_buffer[172]
   crc16_calculate_bytes(sd_sector_buffer[172])
   spi_master = sd_sector_buffer[173]
   crc16_calculate_bytes(sd_sector_buffer[173])
   spi_master = sd_sector_buffer[174]
   crc16_calculate_bytes(sd_sector_buffer[174])
   spi_master = sd_sector_buffer[175]
   crc16_calculate_bytes(sd_sector_buffer[175])
   spi_master = sd_sector_buffer[176]
   crc16_calculate_bytes(sd_sector_buffer[176])
   spi_master = sd_sector_buffer[177]
   crc16_calculate_bytes(sd_sector_buffer[177])
   spi_master = sd_sector_buffer[178]
   crc16_calculate_bytes(sd_sector_buffer[178])
   spi_master = sd_sector_buffer[179]
   crc16_calculate_bytes(sd_sector_buffer[179])
   spi_master = sd_sector_buffer[180]
   crc16_calculate_bytes(sd_sector_buffer[180])
   spi_master = sd_sector_buffer[181]
   crc16_calculate_bytes(sd_sector_buffer[181])
   spi_master = sd_sector_buffer[182]
   crc16_calculate_bytes(sd_sector_buffer[182])
   spi_master = sd_sector_buffer[183]
   crc16_calculate_bytes(sd_sector_buffer[183])
   spi_master = sd_sector_buffer[184]
   crc16_calculate_bytes(sd_sector_buffer[184])
   spi_master = sd_sector_buffer[185]
   crc16_calculate_bytes(sd_sector_buffer[185])
   spi_master = sd_sector_buffer[186]
   crc16_calculate_bytes(sd_sector_buffer[186])
   spi_master = sd_sector_buffer[187]
   crc16_calculate_bytes(sd_sector_buffer[187])
   spi_master = sd_sector_buffer[188]
   crc16_calculate_bytes(sd_sector_buffer[188])
   spi_master = sd_sector_buffer[189]
   crc16_calculate_bytes(sd_sector_buffer[189])
   spi_master = sd_sector_buffer[190]
   crc16_calculate_bytes(sd_sector_buffer[190])
   spi_master = sd_sector_buffer[191]
   crc16_calculate_bytes(sd_sector_buffer[191])
   spi_master = sd_sector_buffer[192]
   crc16_calculate_bytes(sd_sector_buffer[192])
   spi_master = sd_sector_buffer[193]
   crc16_calculate_bytes(sd_sector_buffer[193])
   spi_master = sd_sector_buffer[194]
   crc16_calculate_bytes(sd_sector_buffer[194])
   spi_master = sd_sector_buffer[195]
   crc16_calculate_bytes(sd_sector_buffer[195])
   spi_master = sd_sector_buffer[196]
   crc16_calculate_bytes(sd_sector_buffer[196])
   spi_master = sd_sector_buffer[197]
   crc16_calculate_bytes(sd_sector_buffer[197])
   spi_master = sd_sector_buffer[198]
   crc16_calculate_bytes(sd_sector_buffer[198])
   spi_master = sd_sector_buffer[199]
   crc16_calculate_bytes(sd_sector_buffer[199])
   spi_master = sd_sector_buffer[200]
   crc16_calculate_bytes(sd_sector_buffer[200])
   spi_master = sd_sector_buffer[201]
   crc16_calculate_bytes(sd_sector_buffer[201])
   spi_master = sd_sector_buffer[202]
   crc16_calculate_bytes(sd_sector_buffer[202])
   spi_master = sd_sector_buffer[203]
   crc16_calculate_bytes(sd_sector_buffer[203])
   spi_master = sd_sector_buffer[204]
   crc16_calculate_bytes(sd_sector_buffer[204])
   spi_master = sd_sector_buffer[205]
   crc16_calculate_bytes(sd_sector_buffer[205])
   spi_master = sd_sector_buffer[206]
   crc16_calculate_bytes(sd_sector_buffer[206])
   spi_master = sd_sector_buffer[207]
   crc16_calculate_bytes(sd_sector_buffer[207])
   spi_master = sd_sector_buffer[208]
   crc16_calculate_bytes(sd_sector_buffer[208])
   spi_master = sd_sector_buffer[209]
   crc16_calculate_bytes(sd_sector_buffer[209])
   spi_master = sd_sector_buffer[210]
   crc16_calculate_bytes(sd_sector_buffer[210])
   spi_master = sd_sector_buffer[211]
   crc16_calculate_bytes(sd_sector_buffer[211])
   spi_master = sd_sector_buffer[212]
   crc16_calculate_bytes(sd_sector_buffer[212])
   spi_master = sd_sector_buffer[213]
   crc16_calculate_bytes(sd_sector_buffer[213])
   spi_master = sd_sector_buffer[214]
   crc16_calculate_bytes(sd_sector_buffer[214])
   spi_master = sd_sector_buffer[215]
   crc16_calculate_bytes(sd_sector_buffer[215])
   spi_master = sd_sector_buffer[216]
   crc16_calculate_bytes(sd_sector_buffer[216])
   spi_master = sd_sector_buffer[217]
   crc16_calculate_bytes(sd_sector_buffer[217])
   spi_master = sd_sector_buffer[218]
   crc16_calculate_bytes(sd_sector_buffer[218])
   spi_master = sd_sector_buffer[219]
   crc16_calculate_bytes(sd_sector_buffer[219])
   spi_master = sd_sector_buffer[220]
   crc16_calculate_bytes(sd_sector_buffer[220])
   spi_master = sd_sector_buffer[221]
   crc16_calculate_bytes(sd_sector_buffer[221])
   spi_master = sd_sector_buffer[222]
   crc16_calculate_bytes(sd_sector_buffer[222])
   spi_master = sd_sector_buffer[223]
   crc16_calculate_bytes(sd_sector_buffer[223])
   spi_master = sd_sector_buffer[224]
   crc16_calculate_bytes(sd_sector_buffer[224])
   spi_master = sd_sector_buffer[225]
   crc16_calculate_bytes(sd_sector_buffer[225])
   spi_master = sd_sector_buffer[226]
   crc16_calculate_bytes(sd_sector_buffer[226])
   spi_master = sd_sector_buffer[227]
   crc16_calculate_bytes(sd_sector_buffer[227])
   spi_master = sd_sector_buffer[228]
   crc16_calculate_bytes(sd_sector_buffer[228])
   spi_master = sd_sector_buffer[229]
   crc16_calculate_bytes(sd_sector_buffer[229])
   spi_master = sd_sector_buffer[230]
   crc16_calculate_bytes(sd_sector_buffer[230])
   spi_master = sd_sector_buffer[231]
   crc16_calculate_bytes(sd_sector_buffer[231])
   spi_master = sd_sector_buffer[232]
   crc16_calculate_bytes(sd_sector_buffer[232])
   spi_master = sd_sector_buffer[233]
   crc16_calculate_bytes(sd_sector_buffer[233])
   spi_master = sd_sector_buffer[234]
   crc16_calculate_bytes(sd_sector_buffer[234])
   spi_master = sd_sector_buffer[235]
   crc16_calculate_bytes(sd_sector_buffer[235])
   spi_master = sd_sector_buffer[236]
   crc16_calculate_bytes(sd_sector_buffer[236])
   spi_master = sd_sector_buffer[237]
   crc16_calculate_bytes(sd_sector_buffer[237])
   spi_master = sd_sector_buffer[238]
   crc16_calculate_bytes(sd_sector_buffer[238])
   spi_master = sd_sector_buffer[239]
   crc16_calculate_bytes(sd_sector_buffer[239])
   spi_master = sd_sector_buffer[240]
   crc16_calculate_bytes(sd_sector_buffer[240])
   spi_master = sd_sector_buffer[241]
   crc16_calculate_bytes(sd_sector_buffer[241])
   spi_master = sd_sector_buffer[242]
   crc16_calculate_bytes(sd_sector_buffer[242])
   spi_master = sd_sector_buffer[243]
   crc16_calculate_bytes(sd_sector_buffer[243])
   spi_master = sd_sector_buffer[244]
   crc16_calculate_bytes(sd_sector_buffer[244])
   spi_master = sd_sector_buffer[245]
   crc16_calculate_bytes(sd_sector_buffer[245])
   spi_master = sd_sector_buffer[246]
   crc16_calculate_bytes(sd_sector_buffer[246])
   spi_master = sd_sector_buffer[247]
   crc16_calculate_bytes(sd_sector_buffer[247])
   spi_master = sd_sector_buffer[248]
   crc16_calculate_bytes(sd_sector_buffer[248])
   spi_master = sd_sector_buffer[249]
   crc16_calculate_bytes(sd_sector_buffer[249])
   spi_master = sd_sector_buffer[250]
   crc16_calculate_bytes(sd_sector_buffer[250])
   spi_master = sd_sector_buffer[251]
   crc16_calculate_bytes(sd_sector_buffer[251])
   spi_master = sd_sector_buffer[252]
   crc16_calculate_bytes(sd_sector_buffer[252])
   spi_master = sd_sector_buffer[253]
   crc16_calculate_bytes(sd_sector_buffer[253])
   spi_master = sd_sector_buffer[254]
   crc16_calculate_bytes(sd_sector_buffer[254])
   spi_master = sd_sector_buffer[255]
   crc16_calculate_bytes(sd_sector_buffer[255])
   spi_master = sd_sector_buffer[256]
   crc16_calculate_bytes(sd_sector_buffer[256])
   spi_master = sd_sector_buffer[257]
   crc16_calculate_bytes(sd_sector_buffer[257])
   spi_master = sd_sector_buffer[258]
   crc16_calculate_bytes(sd_sector_buffer[258])
   spi_master = sd_sector_buffer[259]
   crc16_calculate_bytes(sd_sector_buffer[259])
   spi_master = sd_sector_buffer[260]
   crc16_calculate_bytes(sd_sector_buffer[260])
   spi_master = sd_sector_buffer[261]
   crc16_calculate_bytes(sd_sector_buffer[261])
   spi_master = sd_sector_buffer[262]
   crc16_calculate_bytes(sd_sector_buffer[262])
   spi_master = sd_sector_buffer[263]
   crc16_calculate_bytes(sd_sector_buffer[263])
   spi_master = sd_sector_buffer[264]
   crc16_calculate_bytes(sd_sector_buffer[264])
   spi_master = sd_sector_buffer[265]
   crc16_calculate_bytes(sd_sector_buffer[265])
   spi_master = sd_sector_buffer[266]
   crc16_calculate_bytes(sd_sector_buffer[266])
   spi_master = sd_sector_buffer[267]
   crc16_calculate_bytes(sd_sector_buffer[267])
   spi_master = sd_sector_buffer[268]
   crc16_calculate_bytes(sd_sector_buffer[268])
   spi_master = sd_sector_buffer[269]
   crc16_calculate_bytes(sd_sector_buffer[269])
   spi_master = sd_sector_buffer[270]
   crc16_calculate_bytes(sd_sector_buffer[270])
   spi_master = sd_sector_buffer[271]
   crc16_calculate_bytes(sd_sector_buffer[271])
   spi_master = sd_sector_buffer[272]
   crc16_calculate_bytes(sd_sector_buffer[272])
   spi_master = sd_sector_buffer[273]
   crc16_calculate_bytes(sd_sector_buffer[273])
   spi_master = sd_sector_buffer[274]
   crc16_calculate_bytes(sd_sector_buffer[274])
   spi_master = sd_sector_buffer[275]
   crc16_calculate_bytes(sd_sector_buffer[275])
   spi_master = sd_sector_buffer[276]
   crc16_calculate_bytes(sd_sector_buffer[276])
   spi_master = sd_sector_buffer[277]
   crc16_calculate_bytes(sd_sector_buffer[277])
   spi_master = sd_sector_buffer[278]
   crc16_calculate_bytes(sd_sector_buffer[278])
   spi_master = sd_sector_buffer[279]
   crc16_calculate_bytes(sd_sector_buffer[279])
   spi_master = sd_sector_buffer[280]
   crc16_calculate_bytes(sd_sector_buffer[280])
   spi_master = sd_sector_buffer[281]
   crc16_calculate_bytes(sd_sector_buffer[281])
   spi_master = sd_sector_buffer[282]
   crc16_calculate_bytes(sd_sector_buffer[282])
   spi_master = sd_sector_buffer[283]
   crc16_calculate_bytes(sd_sector_buffer[283])
   spi_master = sd_sector_buffer[284]
   crc16_calculate_bytes(sd_sector_buffer[284])
   spi_master = sd_sector_buffer[285]
   crc16_calculate_bytes(sd_sector_buffer[285])
   spi_master = sd_sector_buffer[286]
   crc16_calculate_bytes(sd_sector_buffer[286])
   spi_master = sd_sector_buffer[287]
   crc16_calculate_bytes(sd_sector_buffer[287])
   spi_master = sd_sector_buffer[288]
   crc16_calculate_bytes(sd_sector_buffer[288])
   spi_master = sd_sector_buffer[289]
   crc16_calculate_bytes(sd_sector_buffer[289])
   spi_master = sd_sector_buffer[290]
   crc16_calculate_bytes(sd_sector_buffer[290])
   spi_master = sd_sector_buffer[291]
   crc16_calculate_bytes(sd_sector_buffer[291])
   spi_master = sd_sector_buffer[292]
   crc16_calculate_bytes(sd_sector_buffer[292])
   spi_master = sd_sector_buffer[293]
   crc16_calculate_bytes(sd_sector_buffer[293])
   spi_master = sd_sector_buffer[294]
   crc16_calculate_bytes(sd_sector_buffer[294])
   spi_master = sd_sector_buffer[295]
   crc16_calculate_bytes(sd_sector_buffer[295])
   spi_master = sd_sector_buffer[296]
   crc16_calculate_bytes(sd_sector_buffer[296])
   spi_master = sd_sector_buffer[297]
   crc16_calculate_bytes(sd_sector_buffer[297])
   spi_master = sd_sector_buffer[298]
   crc16_calculate_bytes(sd_sector_buffer[298])
   spi_master = sd_sector_buffer[299]
   crc16_calculate_bytes(sd_sector_buffer[299])
   spi_master = sd_sector_buffer[300]
   crc16_calculate_bytes(sd_sector_buffer[300])
   spi_master = sd_sector_buffer[301]
   crc16_calculate_bytes(sd_sector_buffer[301])
   spi_master = sd_sector_buffer[302]
   crc16_calculate_bytes(sd_sector_buffer[302])
   spi_master = sd_sector_buffer[303]
   crc16_calculate_bytes(sd_sector_buffer[303])
   spi_master = sd_sector_buffer[304]
   crc16_calculate_bytes(sd_sector_buffer[304])
   spi_master = sd_sector_buffer[305]
   crc16_calculate_bytes(sd_sector_buffer[305])
   spi_master = sd_sector_buffer[306]
   crc16_calculate_bytes(sd_sector_buffer[306])
   spi_master = sd_sector_buffer[307]
   crc16_calculate_bytes(sd_sector_buffer[307])
   spi_master = sd_sector_buffer[308]
   crc16_calculate_bytes(sd_sector_buffer[308])
   spi_master = sd_sector_buffer[309]
   crc16_calculate_bytes(sd_sector_buffer[309])
   spi_master = sd_sector_buffer[310]
   crc16_calculate_bytes(sd_sector_buffer[310])
   spi_master = sd_sector_buffer[311]
   crc16_calculate_bytes(sd_sector_buffer[311])
   spi_master = sd_sector_buffer[312]
   crc16_calculate_bytes(sd_sector_buffer[312])
   spi_master = sd_sector_buffer[313]
   crc16_calculate_bytes(sd_sector_buffer[313])
   spi_master = sd_sector_buffer[314]
   crc16_calculate_bytes(sd_sector_buffer[314])
   spi_master = sd_sector_buffer[315]
   crc16_calculate_bytes(sd_sector_buffer[315])
   spi_master = sd_sector_buffer[316]
   crc16_calculate_bytes(sd_sector_buffer[316])
   spi_master = sd_sector_buffer[317]
   crc16_calculate_bytes(sd_sector_buffer[317])
   spi_master = sd_sector_buffer[318]
   crc16_calculate_bytes(sd_sector_buffer[318])
   spi_master = sd_sector_buffer[319]
   crc16_calculate_bytes(sd_sector_buffer[319])
   spi_master = sd_sector_buffer[320]
   crc16_calculate_bytes(sd_sector_buffer[320])
   spi_master = sd_sector_buffer[321]
   crc16_calculate_bytes(sd_sector_buffer[321])
   spi_master = sd_sector_buffer[322]
   crc16_calculate_bytes(sd_sector_buffer[322])
   spi_master = sd_sector_buffer[323]
   crc16_calculate_bytes(sd_sector_buffer[323])
   spi_master = sd_sector_buffer[324]
   crc16_calculate_bytes(sd_sector_buffer[324])
   spi_master = sd_sector_buffer[325]
   crc16_calculate_bytes(sd_sector_buffer[325])
   spi_master = sd_sector_buffer[326]
   crc16_calculate_bytes(sd_sector_buffer[326])
   spi_master = sd_sector_buffer[327]
   crc16_calculate_bytes(sd_sector_buffer[327])
   spi_master = sd_sector_buffer[328]
   crc16_calculate_bytes(sd_sector_buffer[328])
   spi_master = sd_sector_buffer[329]
   crc16_calculate_bytes(sd_sector_buffer[329])
   spi_master = sd_sector_buffer[330]
   crc16_calculate_bytes(sd_sector_buffer[330])
   spi_master = sd_sector_buffer[331]
   crc16_calculate_bytes(sd_sector_buffer[331])
   spi_master = sd_sector_buffer[332]
   crc16_calculate_bytes(sd_sector_buffer[332])
   spi_master = sd_sector_buffer[333]
   crc16_calculate_bytes(sd_sector_buffer[333])
   spi_master = sd_sector_buffer[334]
   crc16_calculate_bytes(sd_sector_buffer[334])
   spi_master = sd_sector_buffer[335]
   crc16_calculate_bytes(sd_sector_buffer[335])
   spi_master = sd_sector_buffer[336]
   crc16_calculate_bytes(sd_sector_buffer[336])
   spi_master = sd_sector_buffer[337]
   crc16_calculate_bytes(sd_sector_buffer[337])
   spi_master = sd_sector_buffer[338]
   crc16_calculate_bytes(sd_sector_buffer[338])
   spi_master = sd_sector_buffer[339]
   crc16_calculate_bytes(sd_sector_buffer[339])
   spi_master = sd_sector_buffer[340]
   crc16_calculate_bytes(sd_sector_buffer[340])
   spi_master = sd_sector_buffer[341]
   crc16_calculate_bytes(sd_sector_buffer[341])
   spi_master = sd_sector_buffer[342]
   crc16_calculate_bytes(sd_sector_buffer[342])
   spi_master = sd_sector_buffer[343]
   crc16_calculate_bytes(sd_sector_buffer[343])
   spi_master = sd_sector_buffer[344]
   crc16_calculate_bytes(sd_sector_buffer[344])
   spi_master = sd_sector_buffer[345]
   crc16_calculate_bytes(sd_sector_buffer[345])
   spi_master = sd_sector_buffer[346]
   crc16_calculate_bytes(sd_sector_buffer[346])
   spi_master = sd_sector_buffer[347]
   crc16_calculate_bytes(sd_sector_buffer[347])
   spi_master = sd_sector_buffer[348]
   crc16_calculate_bytes(sd_sector_buffer[348])
   spi_master = sd_sector_buffer[349]
   crc16_calculate_bytes(sd_sector_buffer[349])
   spi_master = sd_sector_buffer[350]
   crc16_calculate_bytes(sd_sector_buffer[350])
   spi_master = sd_sector_buffer[351]
   crc16_calculate_bytes(sd_sector_buffer[351])
   spi_master = sd_sector_buffer[352]
   crc16_calculate_bytes(sd_sector_buffer[352])
   spi_master = sd_sector_buffer[353]
   crc16_calculate_bytes(sd_sector_buffer[353])
   spi_master = sd_sector_buffer[354]
   crc16_calculate_bytes(sd_sector_buffer[354])
   spi_master = sd_sector_buffer[355]
   crc16_calculate_bytes(sd_sector_buffer[355])
   spi_master = sd_sector_buffer[356]
   crc16_calculate_bytes(sd_sector_buffer[356])
   spi_master = sd_sector_buffer[357]
   crc16_calculate_bytes(sd_sector_buffer[357])
   spi_master = sd_sector_buffer[358]
   crc16_calculate_bytes(sd_sector_buffer[358])
   spi_master = sd_sector_buffer[359]
   crc16_calculate_bytes(sd_sector_buffer[359])
   spi_master = sd_sector_buffer[360]
   crc16_calculate_bytes(sd_sector_buffer[360])
   spi_master = sd_sector_buffer[361]
   crc16_calculate_bytes(sd_sector_buffer[361])
   spi_master = sd_sector_buffer[362]
   crc16_calculate_bytes(sd_sector_buffer[362])
   spi_master = sd_sector_buffer[363]
   crc16_calculate_bytes(sd_sector_buffer[363])
   spi_master = sd_sector_buffer[364]
   crc16_calculate_bytes(sd_sector_buffer[364])
   spi_master = sd_sector_buffer[365]
   crc16_calculate_bytes(sd_sector_buffer[365])
   spi_master = sd_sector_buffer[366]
   crc16_calculate_bytes(sd_sector_buffer[366])
   spi_master = sd_sector_buffer[367]
   crc16_calculate_bytes(sd_sector_buffer[367])
   spi_master = sd_sector_buffer[368]
   crc16_calculate_bytes(sd_sector_buffer[368])
   spi_master = sd_sector_buffer[369]
   crc16_calculate_bytes(sd_sector_buffer[369])
   spi_master = sd_sector_buffer[370]
   crc16_calculate_bytes(sd_sector_buffer[370])
   spi_master = sd_sector_buffer[371]
   crc16_calculate_bytes(sd_sector_buffer[371])
   spi_master = sd_sector_buffer[372]
   crc16_calculate_bytes(sd_sector_buffer[372])
   spi_master = sd_sector_buffer[373]
   crc16_calculate_bytes(sd_sector_buffer[373])
   spi_master = sd_sector_buffer[374]
   crc16_calculate_bytes(sd_sector_buffer[374])
   spi_master = sd_sector_buffer[375]
   crc16_calculate_bytes(sd_sector_buffer[375])
   spi_master = sd_sector_buffer[376]
   crc16_calculate_bytes(sd_sector_buffer[376])
   spi_master = sd_sector_buffer[377]
   crc16_calculate_bytes(sd_sector_buffer[377])
   spi_master = sd_sector_buffer[378]
   crc16_calculate_bytes(sd_sector_buffer[378])
   spi_master = sd_sector_buffer[379]
   crc16_calculate_bytes(sd_sector_buffer[379])
   spi_master = sd_sector_buffer[380]
   crc16_calculate_bytes(sd_sector_buffer[380])
   spi_master = sd_sector_buffer[381]
   crc16_calculate_bytes(sd_sector_buffer[381])
   spi_master = sd_sector_buffer[382]
   crc16_calculate_bytes(sd_sector_buffer[382])
   spi_master = sd_sector_buffer[383]
   crc16_calculate_bytes(sd_sector_buffer[383])
   spi_master = sd_sector_buffer[384]
   crc16_calculate_bytes(sd_sector_buffer[384])
   spi_master = sd_sector_buffer[385]
   crc16_calculate_bytes(sd_sector_buffer[385])
   spi_master = sd_sector_buffer[386]
   crc16_calculate_bytes(sd_sector_buffer[386])
   spi_master = sd_sector_buffer[387]
   crc16_calculate_bytes(sd_sector_buffer[387])
   spi_master = sd_sector_buffer[388]
   crc16_calculate_bytes(sd_sector_buffer[388])
   spi_master = sd_sector_buffer[389]
   crc16_calculate_bytes(sd_sector_buffer[389])
   spi_master = sd_sector_buffer[390]
   crc16_calculate_bytes(sd_sector_buffer[390])
   spi_master = sd_sector_buffer[391]
   crc16_calculate_bytes(sd_sector_buffer[391])
   spi_master = sd_sector_buffer[392]
   crc16_calculate_bytes(sd_sector_buffer[392])
   spi_master = sd_sector_buffer[393]
   crc16_calculate_bytes(sd_sector_buffer[393])
   spi_master = sd_sector_buffer[394]
   crc16_calculate_bytes(sd_sector_buffer[394])
   spi_master = sd_sector_buffer[395]
   crc16_calculate_bytes(sd_sector_buffer[395])
   spi_master = sd_sector_buffer[396]
   crc16_calculate_bytes(sd_sector_buffer[396])
   spi_master = sd_sector_buffer[397]
   crc16_calculate_bytes(sd_sector_buffer[397])
   spi_master = sd_sector_buffer[398]
   crc16_calculate_bytes(sd_sector_buffer[398])
   spi_master = sd_sector_buffer[399]
   crc16_calculate_bytes(sd_sector_buffer[399])
   spi_master = sd_sector_buffer[400]
   crc16_calculate_bytes(sd_sector_buffer[400])
   spi_master = sd_sector_buffer[401]
   crc16_calculate_bytes(sd_sector_buffer[401])
   spi_master = sd_sector_buffer[402]
   crc16_calculate_bytes(sd_sector_buffer[402])
   spi_master = sd_sector_buffer[403]
   crc16_calculate_bytes(sd_sector_buffer[403])
   spi_master = sd_sector_buffer[404]
   crc16_calculate_bytes(sd_sector_buffer[404])
   spi_master = sd_sector_buffer[405]
   crc16_calculate_bytes(sd_sector_buffer[405])
   spi_master = sd_sector_buffer[406]
   crc16_calculate_bytes(sd_sector_buffer[406])
   spi_master = sd_sector_buffer[407]
   crc16_calculate_bytes(sd_sector_buffer[407])
   spi_master = sd_sector_buffer[408]
   crc16_calculate_bytes(sd_sector_buffer[408])
   spi_master = sd_sector_buffer[409]
   crc16_calculate_bytes(sd_sector_buffer[409])
   spi_master = sd_sector_buffer[410]
   crc16_calculate_bytes(sd_sector_buffer[410])
   spi_master = sd_sector_buffer[411]
   crc16_calculate_bytes(sd_sector_buffer[411])
   spi_master = sd_sector_buffer[412]
   crc16_calculate_bytes(sd_sector_buffer[412])
   spi_master = sd_sector_buffer[413]
   crc16_calculate_bytes(sd_sector_buffer[413])
   spi_master = sd_sector_buffer[414]
   crc16_calculate_bytes(sd_sector_buffer[414])
   spi_master = sd_sector_buffer[415]
   crc16_calculate_bytes(sd_sector_buffer[415])
   spi_master = sd_sector_buffer[416]
   crc16_calculate_bytes(sd_sector_buffer[416])
   spi_master = sd_sector_buffer[417]
   crc16_calculate_bytes(sd_sector_buffer[417])
   spi_master = sd_sector_buffer[418]
   crc16_calculate_bytes(sd_sector_buffer[418])
   spi_master = sd_sector_buffer[419]
   crc16_calculate_bytes(sd_sector_buffer[419])
   spi_master = sd_sector_buffer[420]
   crc16_calculate_bytes(sd_sector_buffer[420])
   spi_master = sd_sector_buffer[421]
   crc16_calculate_bytes(sd_sector_buffer[421])
   spi_master = sd_sector_buffer[422]
   crc16_calculate_bytes(sd_sector_buffer[422])
   spi_master = sd_sector_buffer[423]
   crc16_calculate_bytes(sd_sector_buffer[423])
   spi_master = sd_sector_buffer[424]
   crc16_calculate_bytes(sd_sector_buffer[424])
   spi_master = sd_sector_buffer[425]
   crc16_calculate_bytes(sd_sector_buffer[425])
   spi_master = sd_sector_buffer[426]
   crc16_calculate_bytes(sd_sector_buffer[426])
   spi_master = sd_sector_buffer[427]
   crc16_calculate_bytes(sd_sector_buffer[427])
   spi_master = sd_sector_buffer[428]
   crc16_calculate_bytes(sd_sector_buffer[428])
   spi_master = sd_sector_buffer[429]
   crc16_calculate_bytes(sd_sector_buffer[429])
   spi_master = sd_sector_buffer[430]
   crc16_calculate_bytes(sd_sector_buffer[430])
   spi_master = sd_sector_buffer[431]
   crc16_calculate_bytes(sd_sector_buffer[431])
   spi_master = sd_sector_buffer[432]
   crc16_calculate_bytes(sd_sector_buffer[432])
   spi_master = sd_sector_buffer[433]
   crc16_calculate_bytes(sd_sector_buffer[433])
   spi_master = sd_sector_buffer[434]
   crc16_calculate_bytes(sd_sector_buffer[434])
   spi_master = sd_sector_buffer[435]
   crc16_calculate_bytes(sd_sector_buffer[435])
   spi_master = sd_sector_buffer[436]
   crc16_calculate_bytes(sd_sector_buffer[436])
   spi_master = sd_sector_buffer[437]
   crc16_calculate_bytes(sd_sector_buffer[437])
   spi_master = sd_sector_buffer[438]
   crc16_calculate_bytes(sd_sector_buffer[438])
   spi_master = sd_sector_buffer[439]
   crc16_calculate_bytes(sd_sector_buffer[439])
   spi_master = sd_sector_buffer[440]
   crc16_calculate_bytes(sd_sector_buffer[440])
   spi_master = sd_sector_buffer[441]
   crc16_calculate_bytes(sd_sector_buffer[441])
   spi_master = sd_sector_buffer[442]
   crc16_calculate_bytes(sd_sector_buffer[442])
   spi_master = sd_sector_buffer[443]
   crc16_calculate_bytes(sd_sector_buffer[443])
   spi_master = sd_sector_buffer[444]
   crc16_calculate_bytes(sd_sector_buffer[444])
   spi_master = sd_sector_buffer[445]
   crc16_calculate_bytes(sd_sector_buffer[445])
   spi_master = sd_sector_buffer[446]
   crc16_calculate_bytes(sd_sector_buffer[446])
   spi_master = sd_sector_buffer[447]
   crc16_calculate_bytes(sd_sector_buffer[447])
   spi_master = sd_sector_buffer[448]
   crc16_calculate_bytes(sd_sector_buffer[448])
   spi_master = sd_sector_buffer[449]
   crc16_calculate_bytes(sd_sector_buffer[449])
   spi_master = sd_sector_buffer[450]
   crc16_calculate_bytes(sd_sector_buffer[450])
   spi_master = sd_sector_buffer[451]
   crc16_calculate_bytes(sd_sector_buffer[451])
   spi_master = sd_sector_buffer[452]
   crc16_calculate_bytes(sd_sector_buffer[452])
   spi_master = sd_sector_buffer[453]
   crc16_calculate_bytes(sd_sector_buffer[453])
   spi_master = sd_sector_buffer[454]
   crc16_calculate_bytes(sd_sector_buffer[454])
   spi_master = sd_sector_buffer[455]
   crc16_calculate_bytes(sd_sector_buffer[455])
   spi_master = sd_sector_buffer[456]
   crc16_calculate_bytes(sd_sector_buffer[456])
   spi_master = sd_sector_buffer[457]
   crc16_calculate_bytes(sd_sector_buffer[457])
   spi_master = sd_sector_buffer[458]
   crc16_calculate_bytes(sd_sector_buffer[458])
   spi_master = sd_sector_buffer[459]
   crc16_calculate_bytes(sd_sector_buffer[459])
   spi_master = sd_sector_buffer[460]
   crc16_calculate_bytes(sd_sector_buffer[460])
   spi_master = sd_sector_buffer[461]
   crc16_calculate_bytes(sd_sector_buffer[461])
   spi_master = sd_sector_buffer[462]
   crc16_calculate_bytes(sd_sector_buffer[462])
   spi_master = sd_sector_buffer[463]
   crc16_calculate_bytes(sd_sector_buffer[463])
   spi_master = sd_sector_buffer[464]
   crc16_calculate_bytes(sd_sector_buffer[464])
   spi_master = sd_sector_buffer[465]
   crc16_calculate_bytes(sd_sector_buffer[465])
   spi_master = sd_sector_buffer[466]
   crc16_calculate_bytes(sd_sector_buffer[466])
   spi_master = sd_sector_buffer[467]
   crc16_calculate_bytes(sd_sector_buffer[467])
   spi_master = sd_sector_buffer[468]
   crc16_calculate_bytes(sd_sector_buffer[468])
   spi_master = sd_sector_buffer[469]
   crc16_calculate_bytes(sd_sector_buffer[469])
   spi_master = sd_sector_buffer[470]
   crc16_calculate_bytes(sd_sector_buffer[470])
   spi_master = sd_sector_buffer[471]
   crc16_calculate_bytes(sd_sector_buffer[471])
   spi_master = sd_sector_buffer[472]
   crc16_calculate_bytes(sd_sector_buffer[472])
   spi_master = sd_sector_buffer[473]
   crc16_calculate_bytes(sd_sector_buffer[473])
   spi_master = sd_sector_buffer[474]
   crc16_calculate_bytes(sd_sector_buffer[474])
   spi_master = sd_sector_buffer[475]
   crc16_calculate_bytes(sd_sector_buffer[475])
   spi_master = sd_sector_buffer[476]
   crc16_calculate_bytes(sd_sector_buffer[476])
   spi_master = sd_sector_buffer[477]
   crc16_calculate_bytes(sd_sector_buffer[477])
   spi_master = sd_sector_buffer[478]
   crc16_calculate_bytes(sd_sector_buffer[478])
   spi_master = sd_sector_buffer[479]
   crc16_calculate_bytes(sd_sector_buffer[479])
   spi_master = sd_sector_buffer[480]
   crc16_calculate_bytes(sd_sector_buffer[480])
   spi_master = sd_sector_buffer[481]
   crc16_calculate_bytes(sd_sector_buffer[481])
   spi_master = sd_sector_buffer[482]
   crc16_calculate_bytes(sd_sector_buffer[482])
   spi_master = sd_sector_buffer[483]
   crc16_calculate_bytes(sd_sector_buffer[483])
   spi_master = sd_sector_buffer[484]
   crc16_calculate_bytes(sd_sector_buffer[484])
   spi_master = sd_sector_buffer[485]
   crc16_calculate_bytes(sd_sector_buffer[485])
   spi_master = sd_sector_buffer[486]
   crc16_calculate_bytes(sd_sector_buffer[486])
   spi_master = sd_sector_buffer[487]
   crc16_calculate_bytes(sd_sector_buffer[487])
   spi_master = sd_sector_buffer[488]
   crc16_calculate_bytes(sd_sector_buffer[488])
   spi_master = sd_sector_buffer[489]
   crc16_calculate_bytes(sd_sector_buffer[489])
   spi_master = sd_sector_buffer[490]
   crc16_calculate_bytes(sd_sector_buffer[490])
   spi_master = sd_sector_buffer[491]
   crc16_calculate_bytes(sd_sector_buffer[491])
   spi_master = sd_sector_buffer[492]
   crc16_calculate_bytes(sd_sector_buffer[492])
   spi_master = sd_sector_buffer[493]
   crc16_calculate_bytes(sd_sector_buffer[493])
   spi_master = sd_sector_buffer[494]
   crc16_calculate_bytes(sd_sector_buffer[494])
   spi_master = sd_sector_buffer[495]
   crc16_calculate_bytes(sd_sector_buffer[495])
   spi_master = sd_sector_buffer[496]
   crc16_calculate_bytes(sd_sector_buffer[496])
   spi_master = sd_sector_buffer[497]
   crc16_calculate_bytes(sd_sector_buffer[497])
   spi_master = sd_sector_buffer[498]
   crc16_calculate_bytes(sd_sector_buffer[498])
   spi_master = sd_sector_buffer[499]
   crc16_calculate_bytes(sd_sector_buffer[499])
   spi_master = sd_sector_buffer[500]
   crc16_calculate_bytes(sd_sector_buffer[500])
   spi_master = sd_sector_buffer[501]
   crc16_calculate_bytes(sd_sector_buffer[501])
   spi_master = sd_sector_buffer[502]
   crc16_calculate_bytes(sd_sector_buffer[502])
   spi_master = sd_sector_buffer[503]
   crc16_calculate_bytes(sd_sector_buffer[503])
   spi_master = sd_sector_buffer[504]
   crc16_calculate_bytes(sd_sector_buffer[504])
   spi_master = sd_sector_buffer[505]
   crc16_calculate_bytes(sd_sector_buffer[505])
   spi_master = sd_sector_buffer[506]
   crc16_calculate_bytes(sd_sector_buffer[506])
   spi_master = sd_sector_buffer[507]
   crc16_calculate_bytes(sd_sector_buffer[507])
   spi_master = sd_sector_buffer[508]
   crc16_calculate_bytes(sd_sector_buffer[508])
   spi_master = sd_sector_buffer[509]
   crc16_calculate_bytes(sd_sector_buffer[509])
   spi_master = sd_sector_buffer[510]
   crc16_calculate_bytes(sd_sector_buffer[510])
   spi_master = sd_sector_buffer[511]
   crc16_calculate_bytes(sd_sector_buffer[511])
end procedure
end if

--------------------------------------------------------------------------------
-- write one entire sector
--------------------------------------------------------------------------------
procedure sd_write_sector() is
   var byte x
   var word count1

   spi_master = 0xFC       -- send "stop transmission token" write multiple command

   if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
      -- Optimized CRC calculation: Start incremental CRC16 calculation
      crc16_start(512)
      
      -- send sector data with incremental CRC16 calculation
   if defined(SD_WRITE_EXTRA_SPEED) == TRUE then
      if SD_WRITE_EXTRA_SPEED == TRUE then
            -- Use CRC-aware optimized write procedure
            _sd_write_512_crc()
      else
         -- send the data via spi
            for 512 using count1 loop
               spi_master = sd_sector_buffer[count1]
               crc16_calculate_bytes(sd_sector_buffer[count1])
         end loop
      end if
   else
      -- send the data via spi
         for 512 using count1 loop
            spi_master = sd_sector_buffer[count1]
            crc16_calculate_bytes(sd_sector_buffer[count1])
      end loop
   end if

      -- Optimized CRC16 calculation and sending using incremental result
      var word calculated_crc
      var byte crc_high
      var byte crc_low
      
      -- Get the CRC16 result from incremental calculation
      calculated_crc = crc16_get_result()
      
      -- Check for CRC calculation errors
      if _crc16_error_occurred_crc == TRUE then
         sd_error_details = sd_error_details | (word(1) << SD_CRC_ERROR)
         sd_has_error = 1
         -- Send invalid CRC on error
         spi_master = 0xFF  -- send CRC16 high byte
         spi_master = 0xFF  -- send CRC16 low byte
      else
         crc_high = byte((calculated_crc >> 8) & 0xFF)
         crc_low = byte(calculated_crc & 0xFF)
         
         spi_master = crc_high  -- send CRC16 high byte
         spi_master = crc_low   -- send CRC16 low byte
      end if
   else
      -- Original library behavior - send sector data without CRC
      if defined(SD_WRITE_EXTRA_SPEED) == TRUE then
         if SD_WRITE_EXTRA_SPEED == TRUE then
            _sd_write_512()
         else
            -- send the data via spi
            for 512 using count1 loop
             spi_master = sd_sector_buffer[count1]
            end loop
         end if
      else
         -- send the data via spi
         for 512 using count1 loop
          spi_master = sd_sector_buffer[count1]
         end loop
      end if
      
      -- Original library behavior - send 0xFF for CRC
      spi_master = 0xFF  -- send CRC16 high byte (not calculated for individual bytes)
      spi_master = 0xFF  -- send CRC16 low byte (not calculated for individual bytes)
   end if

   sd_sector_count = sd_sector_count + 1 -- increment sector count

   x = spi_master   -- wait for a response
   while x == 0 loop
      x = spi_master
   end loop
   -- response = 010 = data accepted
   -- response = 101 = crc error
   -- response = 110 = write error

   x = spi_master   -- wait for sd card to become ready.
   while x != 0xFF loop
      x = spi_master
   end loop
end procedure

--------------------------------------------------------------------------------
-- write one entire sector with callback to storage_write_callback()
-- for direct reading with spi_master. Make sure you call spi_master
-- chunk_size times in your storage_write_callback().
--------------------------------------------------------------------------------
procedure sd_write_sector_with_callback(word in chunk_size) is
   var byte x
   var word count1

   if sd_byte_count == 0 then
      spi_master = 0xFC       -- send "stop transmission token" write multiple command
   end if

   -- get sector data
   if defined(SD_WRITE_EXTRA_SPEED) == TRUE then
      if SD_WRITE_EXTRA_SPEED == TRUE then
         storage_write_callback(chunk_size)
         sd_byte_count = sd_byte_count + chunk_size
      else
          _error "You can't use callback without SD_WRITE_EXTRA_SPEED == TRUE"
      end if
   else
      _error "You can't use callback without SD_WRITE_EXTRA_SPEED == TRUE"
   end if

   if sd_byte_count == 512 then
      sd_sector_count = sd_sector_count + 1 -- increment sector count

      spi_master = 0xFF  -- send CRC16 high byte (not calculated for individual bytes)
      spi_master = 0xFF  -- send CRC16 low byte (not calculated for individual bytes)

      x = spi_master   -- wait for a response
      while x == 0 loop
         x = spi_master
      end loop
      -- response = 010 = data accepted
      -- response = 101 = crc error
      -- response = 110 = write error

      x = spi_master   -- wait for sd card to become ready
      while x != 0xFF loop
         x = spi_master
      end loop
   end if
end procedure

--------------------------------------------------------------------------------
-- write one entire sector at address
--------------------------------------------------------------------------------
procedure sd_write_sector_address(dword in address) is
   sd_start_write(address)
   sd_write_sector()
   sd_stop_write()
end procedure

-- ----------------------------------------------------------------------------
-- print a sector to an output device
-- ----------------------------------------------------------------------------
procedure sd_print_sector(volatile byte out device, dword in address) is
   sd_start_read(address)
   for SD_BYTE_PER_SECTOR loop
      device = sd_data_byte
   end loop
   sd_stop_read
end procedure

-- ----------------------------------------------------------------------------
-- print a sector to an output device in ascii hex
-- ----------------------------------------------------------------------------
procedure sd_print_sector_hex(volatile byte out device,word in bytes_per_line,dword in address) is
   sd_start_read(address)
   for SD_BYTE_PER_SECTOR / bytes_per_line loop
      print_crlf(device)
      for bytes_per_line loop
         device = " "
         print_byte_hex(device,sd_data_byte)
      end loop
   end loop
   sd_stop_read
end procedure

;   --------------------------------------------------------------------------------
;   -- read CSD or CID to serial port. Example:
;   -- sd_read_csd_cid(SD_SEND_CSD)
;   -- sd_read_csd_cid(SD_SEND_CSD)
;   --------------------------------------------------------------------------------
;   procedure sd_read_csd_cid(byte in command) is
;      sd_enable()  -- enable the sd card
;
;      var byte response,data, step
;      send_command(command,0,response)
;
;      -- wait till ready
;      while spi_master != 0xFE loop      -- wait till data is ready to read
;      end loop
;
;      -- get data
;      for 16 using step loop
;         data = spi_master
;         print_byte_hex(serial_data, data)
;         serial_data = " "
;      end loop
;
;      -- get crc
;      data = spi_master
;      data = spi_master
;
;      sd_disable  -- enable the sd card
;   end procedure

--------------------------------------------------------------------------------
-- Gets sd card size in number of sectors into dword sd_number_of_sectors
-- Total size in bytes = sd_number_of_sectors * 512
--------------------------------------------------------------------------------
 procedure sd_get_number_of_sectors() is
   sd_enable()  -- enable the sd card

   var byte x
   var byte*4 c_size = 0
   var byte _c_size[3] at c_size
   var byte*2 c_size_mult
   var byte _c_size_mult[2] at c_size_mult

   send_command(SD_SEND_CSD,0,x)

   -- wait till ready
   var word step = 0
   while spi_master != 0xFE loop      -- wait till data is ready to read
      if step == 10000 then
         sd_error = SD_COMMAND_TIME_OUT

         return
      end if
      step = step + 1
   end loop

   if sd_card_type == SD_STANDARD_CAPACITY then

      -- throw data we dont' need
      for 6 loop
         x = spi_master
      end loop

      _c_size[2] = spi_master
      _c_size[1] = spi_master
      _c_size[0] = spi_master

      _c_size[2] = _c_size[2] & 0b00000111
      c_size = c_size >> 6

      -- get c_size_mult
      _c_size_mult[1] = spi_master
      _c_size_mult[0] = spi_master

      c_size_mult = (c_size_mult >> 7) & 0b00000111

      -- throw the rest of data we dont' need
      for 5 loop
         x = spi_master
      end loop

      -- get crc
      x = spi_master
      x = spi_master

      sd_disable  -- disable the sd card

      sd_number_of_sectors = (c_size << (c_size_mult + 2))
   else
      -- throw data we dont' need
      for 7 loop
         x = spi_master
      end loop

      _c_size[2] = spi_master & 0b00111111
      _c_size[1] = spi_master
      _c_size[0] = spi_master

      -- throw data we dont' need
      for 6 loop
         x = spi_master
      end loop

      -- get crc
      x = spi_master
      x = spi_master

      sd_disable  -- disable the sd card
      sd_number_of_sectors = (dword(c_size)+1) * 1024

   end if
end procedure

-- =============================================================================
-- Enhanced Error Handling Variables
-- =============================================================================
var byte sd_max_retries = 3
var byte sd_retry_count = 0
var dword sd_error_count = 0
var dword sd_success_count = 0

-- =============================================================================
-- Enhanced Error Handling Procedures
-- =============================================================================

-- Print separator line
procedure sd_seperator() is
   print_string(serial_data, "----")
   print_crlf(serial_data)
end procedure

-- Check for errors and print detailed error information
procedure sd_check_crc_errors() is
   if sd_has_error == TRUE then
      ;if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
      ;   print_string(serial_data, "CRC ERROR DETECTED: ")
      ;else
      ;   print_string(serial_data, "SD ERROR DETECTED: ")
      ;end if
      ;sd_print_error(serial_data)
      
      -- Count specific error types
      ;if (sd_error_details & (word(1) << SD_CRC_ERROR)) > 0 then
      ;   print_string(serial_data, " - CRC Library Error")
      ;   print_crlf(serial_data)
      ;end if
      
      ;if (sd_error_details & (word(1) << SD_COMMAND_CRC_ERROR)) > 0 then
      ;   print_string(serial_data, " - Command CRC Error")
      ;   print_crlf(serial_data)
      ;end if
      
      ;if (sd_error_details & (word(1) << SD_DATA_CRC_ERROR)) > 0 then
      ;   print_string(serial_data, " - Data CRC Error")
      ;   print_crlf(serial_data)
      ;end if
      
      sd_error_count = sd_error_count + 1
   else
      sd_success_count = sd_success_count + 1
   end if
end procedure

-- Reset error state for retry
procedure sd_reset_error_state() is
   pragma inline
   sd_has_error = 0
   sd_error_details = 0
end procedure

-- Simple retry mechanism for operations
procedure sd_retry_operation(dword in sector_address, byte in operation_type) is
   var bit operation_success = FALSE
   sd_retry_count = 0
  
   while (sd_retry_count < sd_max_retries) & (operation_success == FALSE) loop
      sd_reset_error_state()
      
      -- Perform the specified operation
      if operation_type == 1 then
         -- Read sector
         sd_start_read(sector_address)
         if sd_has_error == FALSE then
            sd_stop_read()
         end if
      elsif operation_type == 2 then
         -- Write sector
         sd_start_write(sector_address)
         if sd_has_error == FALSE then
            sd_stop_write()
         end if
      elsif operation_type == 3 then
         -- Read sector buffer
         sd_read_sector_address(sector_address)
      elsif operation_type == 4 then
         -- Write sector buffer
         sd_write_sector_address(sector_address)
      end if
      
      sd_check_crc_errors()
      
      if sd_has_error == FALSE then
         operation_success = TRUE
         print_string(serial_data, "SUCCESS")
         print_crlf(serial_data)
      else
         sd_retry_count = sd_retry_count + 1
         print_string(serial_data, "RETRY ")
         print_byte_dec(serial_data, sd_retry_count)
         print_string(serial_data, "/")
         print_byte_dec(serial_data, sd_max_retries)
         print_crlf(serial_data)
         
         if sd_retry_count < sd_max_retries then
            _usec_delay(100_000)  -- Wait before retry
         end if
      end if
   end loop
   
   if operation_success == FALSE then
      print_string(serial_data, "OPERATION FAILED AFTER ")
      print_byte_dec(serial_data, sd_max_retries)
      print_string(serial_data, " RETRIES")
      print_crlf(serial_data)
   end if
end procedure

-- Print enhanced error handling statistics
procedure sd_print_enhanced_statistics() is
   sd_seperator()
   print_crlf(serial_data)
   
   if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
      print_string(serial_data, "=== CRC ERROR HANDLING STATISTICS ===")
      print_crlf(serial_data)
      print_string(serial_data, "Total operations: ")
      print_dword_dec(serial_data, sd_success_count + sd_error_count)
      print_crlf(serial_data)
      print_string(serial_data, "Successful operations: ")
      print_dword_dec(serial_data, sd_success_count)
      print_crlf(serial_data)
      print_string(serial_data, "Failed operations: ")
      print_dword_dec(serial_data, sd_error_count)
      print_crlf(serial_data)
      
      if sd_error_count > 0 then
         print_string(serial_data, "CRC errors detected and handled with retry mechanism")
      else
         print_string(serial_data, "No CRC errors detected - all operations successful")
      end if
      print_crlf(serial_data)
   else
      if defined(SD_USE_CRC) & (SD_USE_CRC != FALSE) then
         print_string(serial_data, "=== OPERATION STATISTICS (CRC ENABLED) ===")
      else
         print_string(serial_data, "=== OPERATION STATISTICS (CRC DISABLED) ===")
      end if
      print_crlf(serial_data)
      print_string(serial_data, "Total operations: ")
      print_dword_dec(serial_data, sd_success_count + sd_error_count)
      print_crlf(serial_data)
      print_string(serial_data, "Successful operations: ")
      print_dword_dec(serial_data, sd_success_count)
      print_crlf(serial_data)
      print_string(serial_data, "Failed operations: ")
      print_dword_dec(serial_data, sd_error_count)
      print_crlf(serial_data)
      print_string(serial_data, "CRC validation disabled - basic read/write operations only")
      print_crlf(serial_data)
   end if
end procedure


